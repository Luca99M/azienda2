<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medei Caseificio POS</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1c1c1c, #2a2a2a);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #255075, #3a6fa5);
            padding: 25px;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .user-info {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .auth-container {
            background: linear-gradient(145deg, #2a2a2a, #353535);
            border: 2px solid #444;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-container h3 {
            color: #87CEEB;
            margin-bottom: 20px;
        }

        .config-section {
            background: linear-gradient(145deg, #2a2a2a, #353535);
            border: 2px solid #444;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .config-section h3 {
            color: #87CEEB;
            margin-bottom: 20px;
        }

        .config-input {
            background: #444;
            color: white;
            border: 2px solid #555;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            margin-bottom: 15px;
        }

        .operators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .operator-card {
            background: linear-gradient(145deg, #2a2a2a, #353535);
            border: 2px solid #444;
            padding: 30px 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .operator-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .operator-card:hover {
            transform: translateY(-8px);
            border-color: #255075;
            box-shadow: 0 12px 40px rgba(37, 80, 117, 0.3);
        }

        .operator-card:hover::before {
            left: 100%;
        }

        .operator-card h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .operator-icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .menu-item {
            background: linear-gradient(145deg, #2a2a2a, #353535);
            border: 2px solid #444;
            padding: 40px 30px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .menu-item:hover {
            transform: translateY(-5px);
            border-color: #255075;
            background: linear-gradient(145deg, #255075, #2a5080);
        }

        .menu-item h3 {
            font-size: 1.8em;
            margin-bottom: 15px;
        }

        .menu-item p {
            opacity: 0.8;
            font-size: 1.1em;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .product-card {
            background: linear-gradient(145deg, #2a2a2a, #353535);
            border: 2px solid #444;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .product-card:hover {
            border-color: #255075;
            transform: translateY(-3px);
        }

        .product-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #87CEEB;
        }

        .quantity-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .btn {
            background: linear-gradient(145deg, #255075, #1a3a5a);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .btn:hover {
            background: linear-gradient(145deg, #1a3a5a, #255075);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .btn-success {
            background: linear-gradient(145deg, #28a745, #1e7e34);
        }

        .btn-success:hover {
            background: linear-gradient(145deg, #1e7e34, #28a745);
        }

        .btn-danger {
            background: linear-gradient(145deg, #dc3545, #bd2130);
        }

        .btn-danger:hover {
            background: linear-gradient(145deg, #bd2130, #dc3545);
        }

        .btn-large {
            padding: 15px 30px;
            font-size: 18px;
        }

        .quantity-display {
            background: #444;
            color: #87CEEB;
            border: 2px solid #555;
            padding: 12px 20px;
            width: 80px;
            text-align: center;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
        }

        .cart-panel {
            position: fixed;
            top: 50%;
            right: 30px;
            transform: translateY(-50%);
            background: linear-gradient(145deg, #1a1a1a, #2a2a2a);
            border: 2px solid #255075;
            padding: 25px;
            border-radius: 15px;
            min-width: 350px;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .cart-header {
            color: #87CEEB;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #255075;
            padding-bottom: 10px;
        }

        .cart-items {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #444;
        }

        .cart-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .input-field {
            background: #444;
            color: white;
            border: 2px solid #555;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #255075;
            box-shadow: 0 0 10px rgba(37, 80, 117, 0.3);
        }

        .fatturatore-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .fatturatore-card {
            background: linear-gradient(145deg, #2a2a2a, #353535);
            border: 2px solid #444;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .fatturatore-card:hover,
        .fatturatore-card.selected {
            border-color: #255075;
            background: linear-gradient(145deg, #255075, #2a5080);
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
        }

        .status-message {
            background: #255075;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .success {
            background: #28a745;
        }

        .error {
            background: #dc3545;
        }

        .warning {
            background: #ffc107;
            color: #000;
        }

        .back-button {
            margin-top: 20px;
        }

        .last-operation {
            background: linear-gradient(145deg, #2a2a2a, #353535);
            border: 2px solid #444;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .last-operation h3 {
            color: #87CEEB;
            margin-bottom: 15px;
        }

        .last-operation p {
            font-size: 1.1em;
            line-height: 1.4;
            margin-bottom: 15px;
        }

        .management-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .cella-stats {
            background: linear-gradient(145deg, #2a2a2a, #353535);
            border: 2px solid #444;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .cella-stats h3 {
            color: #87CEEB;
            margin-bottom: 15px;
        }

        .stat-item {
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .cart-panel {
                position: fixed;
                top: auto;
                bottom: 0;
                right: 0;
                left: 0;
                transform: none;
                border-radius: 15px 15px 0 0;
                max-width: none;
            }

            .operators-grid,
            .menu-grid,
            .products-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .management-buttons {
                flex-direction: column;
            }
        }

        .virtual-keyboard {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
            padding: 20px;
            border-top: 3px solid #255075;
            z-index: 2000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .virtual-keyboard.show {
            transform: translateY(0);
        }

        .keyboard-input {
            background: #444;
            color: white;
            border: 2px solid #555;
            padding: 15px;
            border-radius: 8px;
            font-size: 18px;
            margin-bottom: 20px;
            width: 100%;
            text-align: center;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 8px 0;
        }

        .key {
            background: linear-gradient(145deg, #444, #333);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            min-width: 50px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .key:hover {
            background: linear-gradient(145deg, #555, #444);
            transform: translateY(-2px);
        }

        .key.wide {
            min-width: 100px;
        }

        .key.extra-wide {
            min-width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🧀 Medei Caseificio POS</h1>
            <div class="user-info" id="user-info">Credenziali configurate - Autenticazione richiesta</div>
        </div>

        <!-- Configurazione OAuth -->
        <div id="config-section" class="config-section">
            <h3>🔧 Configurazione Client ID OAuth2</h3>
            <p style="margin-bottom: 20px; color: #ffd93d;">⚠️ <strong>ATTENZIONE:</strong> Inserisci il tuo Client ID OAuth2 nel codice alla riga con <code>TUO_CLIENT_ID_OAUTH2_QUI</code></p>
            
            <div style="margin-top: 20px; padding: 15px; background: #444; border-radius: 8px; font-size: 14px;">
                <strong>📋 Come ottenere il Client ID OAuth2:</strong><br>
                1. Vai su <a href="https://console.developers.google.com" target="_blank" style="color: #87CEEB;">Google Cloud Console</a><br>
                2. Crea progetto "Medei POS"<br>
                3. Abilita "Google Drive API"<br>
                4. Credenziali → Crea → ID client OAuth 2.0<br>
                5. Copia il Client ID e inseriscilo nel codice<br>
                6. Aggiungi domini autorizzati nelle impostazioni OAuth
            </div>
        </div>

        <!-- Autenticazione -->
        <div id="auth-container" class="auth-container hidden">
            <h3>🔐 Autenticazione Google Drive</h3>
            <p id="auth-status">Inizializzazione...</p>
            <button id="auth-button" class="btn btn-large hidden" onclick="signIn()">🔑 Accedi con Google</button>
            <button id="signout-button" class="btn btn-danger hidden" onclick="signOut()">🚪 Disconnetti</button>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading hidden">
            <h2>🔄 Caricamento dati...</h2>
            <p>Lettura CSV da Google Drive...</p>
        </div>

        <!-- Selezione Operatori -->
        <div id="operator-selection" class="hidden">
            <h2 style="text-align: center; margin-bottom: 30px; color: #87CEEB;">Seleziona Operatore</h2>
            
            <!-- Pulsanti gestione -->
            <div class="management-buttons">
                <button class="btn btn-large" onclick="showMagazzino()">📦 Magazzino</button>
                <button class="btn btn-large" onclick="showCellaFrigo()">🧀 Gestione Cella Frigo</button>
            </div>

            <!-- Ultima operazione -->
            <div id="last-operation" class="last-operation">
                <h3>📝 Ultima Operazione</h3>
                <p id="last-operation-text">Caricamento...</p>
                <button class="btn btn-danger" onclick="deleteLastOperation()">🗑️ Elimina Ultima</button>
            </div>

            <div class="operators-grid">
                <div class="operator-card" onclick="selectOperator('Andrea')">
                    <span class="operator-icon">👨‍💼</span>
                    <h3>Andrea</h3>
                </div>
                <div class="operator-card" onclick="selectOperator('Doriano')">
                    <span class="operator-icon">👨‍💼</span>
                    <h3>Doriano</h3>
                </div>
                <div class="operator-card" onclick="selectOperator('Marco')">
                    <span class="operator-icon">👨‍💼</span>
                    <h3>Marco</h3>
                </div>
                <div class="operator-card" onclick="selectOperator('Liliana')">
                    <span class="operator-icon">👩‍💼</span>
                    <h3>Liliana</h3>
                </div>
                <div class="operator-card" onclick="selectOperator('Mara')">
                    <span class="operator-icon">👩‍💼</span>
                    <h3>Mara</h3>
                </div>
                <div class="operator-card" onclick="selectOperator('Massimo')">
                    <span class="operator-icon">👨‍💼</span>
                    <h3>Massimo</h3>
                </div>
                <div class="operator-card" onclick="selectOperator('Marzio')">
                    <span class="operator-icon">👨‍💼</span>
                    <h3>Marzio</h3>
                </div>
                <div class="operator-card" onclick="selectOperator('Luca')">
                    <span class="operator-icon">👨‍💼</span>
                    <h3>Luca</h3>
                </div>
                <div class="operator-card" onclick="selectOperator('Paolo')">
                    <span class="operator-icon">👨‍💼</span>
                    <h3>Paolo</h3>
                </div>
                <div class="operator-card" onclick="selectOperator('Silvio')">
                    <span class="operator-icon">👨‍💼</span>
                    <h3>Silvio</h3>
                </div>
                <div class="operator-card" onclick="selectOperator('Gabriele')">
                    <span class="operator-icon">👨‍💼</span>
                    <h3>Gabriele</h3>
                </div>
                <div class="operator-card" onclick="selectOperator('Elisa')">
                    <span class="operator-icon">👩‍💼</span>
                    <h3>Elisa</h3>
                </div>
            </div>
        </div>

        <!-- Menu Principale -->
        <div id="main-menu" class="hidden">
            <h2 style="text-align: center; margin-bottom: 30px; color: #87CEEB;">Menu Principale</h2>
            <div class="menu-grid">
                <div class="menu-item" onclick="showVendite()">
                    <h3>💰 Vendite</h3>
                    <p>Registra vendite e incassi</p>
                </div>
                <div class="menu-item" onclick="showFatturazione()">
                    <h3>📄 Fatturazione</h3>
                    <p>Gestisci fatture clienti</p>
                </div>
                <div class="menu-item" onclick="showProdottiAggiunti()">
                    <h3>📦 Aggiungi Prodotti</h3>
                    <p>Carica nuovo magazzino</p>
                </div>
                <div class="menu-item" onclick="showSoldiInseriti()">
                    <h3>💵 Soldi Inseriti</h3>
                    <p>Registra contante in cassa</p>
                </div>
            </div>
            <div class="back-button">
                <button class="btn btn-large" onclick="showOperatorSelection()">← Cambia Operatore</button>
            </div>
        </div>

        <!-- Vendite -->
        <div id="vendite" class="hidden">
            <h2 style="color: #87CEEB; margin-bottom: 30px;">💰 Vendite</h2>
            <div class="products-grid" id="products-vendite"></div>
            <div class="back-button">
                <button class="btn btn-large" onclick="showMainMenu()">← Torna al Menu</button>
            </div>
        </div>

        <!-- Fatturazione -->
        <div id="fatturazione" class="hidden">
            <h2 style="color: #87CEEB; margin-bottom: 30px;">📄 Fatturazione</h2>
            
            <h3 style="margin-bottom: 20px;">Seleziona Fatturatore:</h3>
            <div class="fatturatore-grid" id="fatturatore-grid">
                <div class="fatturatore-card" onclick="selectFatturatore('Bancomat')">Bancomat</div>
                <div class="fatturatore-card" onclick="selectFatturatore('Conad (Trevi)')">Conad (Trevi)</div>
                <div class="fatturatore-card" onclick="selectFatturatore('Ulivo')">Ulivo</div>
                <div class="fatturatore-card" onclick="selectFatturatore('Pizzeria (Coste)')">Pizzeria (Coste)</div>
                <div class="fatturatore-card" onclick="selectFatturatore('Spello (mercato)')">Spello (mercato)</div>
                <div class="fatturatore-card" onclick="selectFatturatore('Medei (macellaio)')">Medei (macellaio)</div>
                <div class="fatturatore-card" onclick="selectFatturatore('Vescia')">Vescia</div>
                <div class="fatturatore-card" onclick="selectFatturatore('Conad (PG)')">Conad (PG)</div>
                <div class="fatturatore-card" onclick="selectFatturatore('Chalet (PG)')">Chalet (PG)</div>
                <div class="fatturatore-card" onclick="selectFatturatore('Caminetto')">Caminetto</div>
                <div class="fatturatore-card" onclick="selectFatturatore('Terziere')">Terziere</div>
                <div class="fatturatore-card" onclick="selectFatturatore('Altro')">Altro</div>
            </div>

            <div class="products-grid" id="products-fatturazione"></div>
            <div class="back-button">
                <button class="btn btn-large" onclick="showMainMenu()">← Torna al Menu</button>
            </div>
        </div>

        <!-- Prodotti Aggiunti -->
        <div id="prodotti-aggiunti" class="hidden">
            <h2 style="color: #87CEEB; margin-bottom: 30px;">📦 Aggiungi Prodotti</h2>
            <div class="products-grid" id="products-aggiunti"></div>
            <div class="back-button">
                <button class="btn btn-large" onclick="showMainMenu()">← Torna al Menu</button>
            </div>
        </div>

        <!-- Soldi Inseriti -->
        <div id="soldi-inseriti" class="hidden">
            <h2 style="color: #87CEEB; margin-bottom: 30px;">💵 Soldi Inseriti in Cassa</h2>
            <div style="text-align: center; padding: 50px;">
                <div class="product-card" style="max-width: 400px; margin: 0 auto;">
                    <h3>Importo da Inserire</h3>
                    <div style="margin: 30px 0;">
                        <input type="number" class="input-field" id="soldi-importo" placeholder="€ 0.00" step="0.01" style="font-size: 24px; padding: 20px; text-align: center;">
                    </div>
                    <button class="btn btn-success btn-large" onclick="confermaSoldi()">💰 Conferma Inserimento</button>
                </div>
            </div>
            <div class="back-button">
                <button class="btn btn-large" onclick="showMainMenu()">← Torna al Menu</button>
            </div>
        </div>

        <!-- Cella Frigo -->
        <div id="cella-frigo" class="hidden">
            <h2 style="color: #87CEEB; margin-bottom: 30px;">🧀 Gestione Produzione</h2>
            
            <!-- Statistiche Cella -->
            <div class="cella-stats">
                <h3>📊 Stato Cella Frigo</h3>
                <div id="cella-stats-content">Caricamento statistiche...</div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                <div class="product-card">
                    <h3>Forme Aggiunte in Cella</h3>
                    <div class="quantity-controls" style="margin-top: 20px;">
                        <button class="btn btn-danger" onclick="adjustCellaCount('forme', -10)">-10</button>
                        <button class="btn btn-danger" onclick="adjustCellaCount('forme', -1)">-</button>
                        <input type="number" class="quantity-display" id="forme-count" value="0" readonly>
                        <button class="btn btn-success" onclick="adjustCellaCount('forme', 1)">+</button>
                        <button class="btn btn-success" onclick="adjustCellaCount('forme', 10)">+10</button>
                    </div>
                </div>

                <div class="product-card">
                    <h3>Ricotta Prodotta (al negozio)</h3>
                    <div class="quantity-controls" style="margin-top: 20px;">
                        <button class="btn btn-danger" onclick="adjustCellaCount('ricotta', -10)">-10</button>
                        <button class="btn btn-danger" onclick="adjustCellaCount('ricotta', -1)">-</button>
                        <input type="number" class="quantity-display" id="ricotta-count" value="0" readonly>
                        <button class="btn btn-success" onclick="adjustCellaCount('ricotta', 1)">+</button>
                        <button class="btn btn-success" onclick="adjustCellaCount('ricotta', 10)">+10</button>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-bottom: 30px;">
                <button class="btn btn-success btn-large" onclick="registraProduzione()">Registra Produzione</button>
                <button class="btn btn-large" onclick="refreshCellaStats()" style="margin-left: 20px;">🔄 Aggiorna Statistiche</button>
            </div>

            <div class="back-button">
                <button class="btn btn-large" onclick="showOperatorSelection()">← Torna alla Selezione</button>
            </div>
        </div>

        <!-- Magazzino -->
        <div id="magazzino" class="hidden">
            <h2 style="color: #87CEEB; margin-bottom: 30px;">📦 Stato Magazzino</h2>
            <div id="magazzino-content">
                <div class="loading">Caricamento dati magazzino...</div>
            </div>
            <div class="back-button">
                <button class="btn btn-large" onclick="showOperatorSelection()">← Torna alla Selezione</button>
            </div>
        </div>

        <!-- Carrello (mostrato quando in modalità vendite/fatturazione) -->
        <div id="cart" class="cart-panel hidden">
            <div class="cart-header">🛒 Carrello</div>
            <div class="cart-items" id="cart-items">
                <div style="text-align: center; color: #666; padding: 20px;">Carrello vuoto</div>
            </div>
            <div class="cart-controls">
                <input type="number" class="input-field" id="importo" placeholder="Importo inserito (€)" step="0.01">
                <input type="text" class="input-field" id="note" placeholder="Note" onclick="showVirtualKeyboard('note')">
                <button class="btn btn-success btn-large" onclick="confermaOperazione()">✅ Conferma</button>
                <button class="btn btn-danger" onclick="resetCart()">🗑️ Reset</button>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="status-message" class="hidden"></div>
    </div>

    <!-- Tastiera Virtuale -->
    <div id="virtual-keyboard" class="virtual-keyboard">
        <input type="text" class="keyboard-input" id="keyboard-input" placeholder="Digita qui...">
        
        <div class="keyboard-row">
            <button class="key" onclick="addToKeyboard('1')">1</button>
            <button class="key" onclick="addToKeyboard('2')">2</button>
            <button class="key" onclick="addToKeyboard('3')">3</button>
            <button class="key" onclick="addToKeyboard('4')">4</button>
            <button class="key" onclick="addToKeyboard('5')">5</button>
            <button class="key" onclick="addToKeyboard('6')">6</button>
            <button class="key" onclick="addToKeyboard('7')">7</button>
            <button class="key" onclick="addToKeyboard('8')">8</button>
            <button class="key" onclick="addToKeyboard('9')">9</button>
            <button class="key" onclick="addToKeyboard('0')">0</button>
        </div>
        
        <div class="keyboard-row">
            <button class="key" onclick="addToKeyboard('Q')">Q</button>
            <button class="key" onclick="addToKeyboard('W')">W</button>
            <button class="key" onclick="addToKeyboard('E')">E</button>
            <button class="key" onclick="addToKeyboard('R')">R</button>
            <button class="key" onclick="addToKeyboard('T')">T</button>
            <button class="key" onclick="addToKeyboard('Y')">Y</button>
            <button class="key" onclick="addToKeyboard('U')">U</button>
            <button class="key" onclick="addToKeyboard('I')">I</button>
            <button class="key" onclick="addToKeyboard('O')">O</button>
            <button class="key" onclick="addToKeyboard('P')">P</button>
        </div>
        
        <div class="keyboard-row">
            <button class="key" onclick="addToKeyboard('A')">A</button>
            <button class="key" onclick="addToKeyboard('S')">S</button>
            <button class="key" onclick="addToKeyboard('D')">D</button>
            <button class="key" onclick="addToKeyboard('F')">F</button>
            <button class="key" onclick="addToKeyboard('G')">G</button>
            <button class="key" onclick="addToKeyboard('H')">H</button>
            <button class="key" onclick="addToKeyboard('J')">J</button>
            <button class="key" onclick="addToKeyboard('K')">K</button>
            <button class="key" onclick="addToKeyboard('L')">L</button>
            <button class="key" onclick="addToKeyboard('€')">€</button>
        </div>
        
        <div class="keyboard-row">
            <button class="key" onclick="addToKeyboard('Z')">Z</button>
            <button class="key" onclick="addToKeyboard('X')">X</button>
            <button class="key" onclick="addToKeyboard('C')">C</button>
            <button class="key" onclick="addToKeyboard('V')">V</button>
            <button class="key" onclick="addToKeyboard('B')">B</button>
            <button class="key" onclick="addToKeyboard('N')">N</button>
            <button class="key" onclick="addToKeyboard('M')">M</button>
            <button class="key" onclick="addToKeyboard(',')">,</button>
            <button class="key" onclick="addToKeyboard('.')">.</button>
        </div>
        
        <div class="keyboard-row">
            <button class="key extra-wide" onclick="addToKeyboard(' ')">Spazio</button>
            <button class="key wide" onclick="keyboardBackspace()">Cancella</button>
            <button class="key wide btn-success" onclick="confirmKeyboard()">OK</button>
            <button class="key wide btn-danger" onclick="hideVirtualKeyboard()">Chiudi</button>
        </div>
    </div>

    <script>
        // ==========================================
        // VARIABILI GLOBALI - CREDENZIALI INSERITE
        // ==========================================
        const CLIENT_ID = '589546025220-gblcf5jnk45vsst58c03n4r87er8sg30.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDKaQZVRy5V5lYSEK5fyOqBFMjFbT6giSs';           
        const CSV_FOLDER_ID = '1tJ-0du5OwdlgMxAWFHijhWna8vwYQYZd';
        
        let currentOperator = '';
        let currentMode = '';
        let selectedFatturatore = '';
        let cart = {};
        let csvFiles = {};
        let isAuthenticated = false;
        let keyboardTarget = null;
        let lastOperationData = null;

        // Scopes per Google Drive
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        // Prodotti standard (dal sistema Python)
        const products = [
            'Formaggio', 'Mezza Forma', 'Forma_Stagionata', 'MezzaForma_Stag',
            'Ricotta', 'Miele', 'Noci_1kg', 'Noci_3kg',
            'Olio_0.25L', 'Olio_0.5L', 'Olio_0.75L', 'Olio_1L', 'Olio_2L', 'Olio_3L', 'Olio_5L',
            'Grattugiato', 'Prod_17', 'Prod_18', 'Prod_19', 'Prod_20', 'Prod_21', 'Prod_22',
            'Prod_23', 'Prod_24', 'Prod_25', 'Prod_26', 'Prod_27', 'Prod_28', 'Prod_29', 'Prod_30'
        ];

        // Prodotti per "Aggiungi Prodotti" (senza Mezza Forma, come nel Python)
        const productsAggiunti = products.filter(p => p !== 'Mezza Forma');

        // Strutture CSV (come nel sistema Python)
        const csvStructures = {
            vendite: ['Data', 'Ora', 'Operatore', ...products, 'Note', 'ImportoInserito'],
            fatturato: ['Data', 'Ora', 'Operatore', 'Fatturatore', ...products, 'Note'],
            prodotti_aggiunti: ['Data', 'Ora', 'Operatore', ...productsAggiunti],
            soldi: ['Data', 'Ora', 'Importo'],
            produzione_cella_frigo: ['Data', 'Ora', 'Forme']
        };

        // ==========================================
        // INIZIALIZZAZIONE
        // ==========================================
        function initApp() {
            if (CLIENT_ID === 'TUO_CLIENT_ID_OAUTH2_QUI') {
                showStatus('⚠️ CONFIGURAZIONE RICHIESTA: Inserisci CLIENT_ID nel codice alla riga 328', 'warning');
                return;
            }
            
            document.getElementById('config-section').classList.add('hidden');
            document.getElementById('auth-container').classList.remove('hidden');
            document.getElementById('auth-status').textContent = 'Inizializzazione Google API...';
            
            gapi.load('client:auth2', initAuth);
        }

        async function initAuth() {
            try {
                // Verifica che gapi.client sia disponibile
                if (!gapi.client) {
                    throw new Error('Google API Client non caricato');
                }

                await gapi.client.init({
                    apiKey: API_KEY,
                    clientId: CLIENT_ID,
                    discoveryDocs: DISCOVERY_DOCS,
                    scope: SCOPES
                });
                
                const authInstance = gapi.auth2.getAuthInstance();
                
                // Controlla se già autenticato
                if (authInstance.isSignedIn.get()) {
                    isAuthenticated = true;
                    document.getElementById('auth-status').textContent = '✅ Connesso a Google Drive';
                    document.getElementById('signout-button').classList.remove('hidden');
                    loadApp();
                } else {
                    document.getElementById('auth-status').textContent = '🔑 Accesso richiesto a Google Drive';
                    document.getElementById('auth-button').classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Errore inizializzazione auth:', error);
                document.getElementById('auth-status').textContent = '❌ Errore connessione Google';
                showStatus(`Errore Google API: ${error.message}`, 'error');
            }
        }

        async function signIn() {
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                await authInstance.signIn();
                
                isAuthenticated = true;
                document.getElementById('auth-button').classList.add('hidden');
                document.getElementById('signout-button').classList.remove('hidden');
                document.getElementById('auth-status').textContent = '✅ Connesso a Google Drive';
                
                loadApp();
                
            } catch (error) {
                console.error('Errore sign in:', error);
                showStatus('Errore durante il login Google', 'error');
            }
        }

        async function signOut() {
            const authInstance = gapi.auth2.getAuthInstance();
            await authInstance.signOut();
            
            isAuthenticated = false;
            document.getElementById('auth-button').classList.remove('hidden');
            document.getElementById('signout-button').classList.add('hidden');
            document.getElementById('auth-status').textContent = '🔑 Accesso richiesto a Google Drive';
            
            hideAll();
            document.getElementById('auth-container').classList.remove('hidden');
        }

        async function loadApp() {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            
            try {
                await loadCSVList();
                await loadLastOperation();
                
                setTimeout(() => {
                    document.getElementById('loading').classList.add('hidden');
                    showOperatorSelection();
                }, 1000);
                
            } catch (error) {
                console.error('Errore caricamento app:', error);
                showStatus('Errore caricamento dati. Riprova.', 'error');
            }
        }

        // ==========================================
        // GESTIONE CSV SU GOOGLE DRIVE
        // ==========================================
        async function loadCSVList() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `'${CSV_FOLDER_ID}' in parents and mimeType='text/csv'`,
                    fields: 'files(id, name)'
                });
                
                csvFiles = {};
                response.result.files.forEach(file => {
                    const name = file.name.replace('.csv', '');
                    csvFiles[name] = file.id;
                });
                
                console.log('✅ CSV files trovati:', csvFiles);
                
                // Verifica che esistano i 5 CSV richiesti
                const requiredCSVs = ['vendite', 'fatturato', 'prodotti_aggiunti', 'soldi', 'produzione_cella_frigo'];
                const foundCSVs = requiredCSVs.filter(csv => csvFiles[csv]);
                const missingCSVs = requiredCSVs.filter(csv => !csvFiles[csv]);
                
                console.log('✅ CSV trovati:', foundCSVs);
                if (missingCSVs.length > 0) {
                    console.log('⚠️ CSV mancanti:', missingCSVs);
                    showStatus(`⚠️ CSV mancanti: ${missingCSVs.join(', ')}. Verifica nella cartella Google Drive.`, 'warning');
                }
                
            } catch (error) {
                console.error('Errore caricamento lista CSV:', error);
                showStatus('Errore accesso cartella CSV. Verifica permessi Google Drive.', 'error');
                throw error;
            }
        }

        async function readCSV(fileName) {
            try {
                if (!csvFiles[fileName]) {
                    console.log(`File ${fileName}.csv non trovato nella cartella`);
                    showStatus(`CSV ${fileName} non trovato. Verifica nella cartella Google Drive.`, 'error');
                    return [];
                }
                
                const response = await gapi.client.drive.files.get({
                    fileId: csvFiles[fileName],
                    alt: 'media'
                });
                
                return parseCSV(response.body);
                
            } catch (error) {
                console.error(`Errore lettura ${fileName}:`, error);
                return [];
            }
        }

        function parseCSV(csvContent) {
            if (!csvContent || csvContent.trim() === '') return [];
            
            const lines = csvContent.split('\n').filter(line => line.trim());
            if (lines.length <= 1) return [];
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const row = {};
                
                headers.forEach((header, index) => {
                    let value = values[index] ? values[index].trim().replace(/"/g, '') : '';
                    
                    // Conversione automatica numeri
                    if (value && !isNaN(value) && value !== '') {
                        value = parseFloat(value);
                    }
                    
                    row[header] = value;
                });
                
                data.push(row);
            }
            
            return data;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        function formatCSV(headers, data) {
            let csv = headers.join(',') + '\n';
            
            data.forEach(row => {
                const values = headers.map(header => {
                    let value = row[header] || '';
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        value = `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                });
                csv += values.join(',') + '\n';
            });
            
            return csv;
        }

        async function writeCSV(fileName, data) {
            try {
                const headers = csvStructures[fileName];
                if (!headers) {
                    throw new Error(`Struttura CSV non definita per ${fileName}`);
                }
                
                if (!csvFiles[fileName]) {
                    throw new Error(`File ${fileName}.csv non trovato nella cartella Google Drive`);
                }
                
                const csvContent = formatCSV(headers, data);
                
                // Aggiorna file esistente
                const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${csvFiles[fileName]}?uploadType=media`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': 'Bearer ' + gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token,
                        'Content-Type': 'text/csv'
                    },
                    body: csvContent
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return true;
                
            } catch (error) {
                console.error(`Errore scrittura ${fileName}:`, error);
                throw error;
            }
        }

        async function appendToCSV(fileName, record) {
            try {
                // Leggi dati esistenti
                const existingData = await readCSV(fileName);
                
                // Aggiungi nuovo record
                existingData.push(record);
                
                // Salva tutto
                await writeCSV(fileName, existingData);
                
                return true;
                
            } catch (error) {
                console.error(`Errore append ${fileName}:`, error);
                throw error;
            }
        }

        // ==========================================
        // GESTIONE ULTIMA OPERAZIONE
        // ==========================================
        async function loadLastOperation() {
            try {
                let latestOperation = null;
                let latestTable = '';
                let latestIndex = -1;
                let latestDateTime = null;
                
                // Controlla tutte le tabelle per trovare l'ultima operazione
                for (const tableName of ['vendite', 'fatturato', 'prodotti_aggiunti', 'soldi', 'produzione_cella_frigo']) {
                    const data = await readCSV(tableName);
                    if (data.length > 0) {
                        const lastRecord = data[data.length - 1];
                        
                        // Parsing data italiana
                        const dateParts = lastRecord.Data.split('-');
                        const timeParts = lastRecord.Ora.split(':');
                        const dateTime = new Date(
                            parseInt(dateParts[2]), // anno
                            parseInt(dateParts[1]) - 1, // mese (0-based)
                            parseInt(dateParts[0]), // giorno
                            parseInt(timeParts[0]), // ore
                            parseInt(timeParts[1]), // minuti
                            parseInt(timeParts[2]) || 0 // secondi
                        );
                        
                        if (!latestDateTime || dateTime > latestDateTime) {
                            latestOperation = lastRecord;
                            latestTable = tableName;
                            latestIndex = data.length - 1;
                            latestDateTime = dateTime;
                        }
                    }
                }
                
                lastOperationData = { record: latestOperation, table: latestTable, index: latestIndex };
                displayLastOperation();
                
            } catch (error) {
                console.error('Errore caricamento ultima operazione:', error);
                document.getElementById('last-operation-text').textContent = 'Errore caricamento ultima operazione';
            }
        }

        function displayLastOperation() {
            const textElement = document.getElementById('last-operation-text');
            
            if (!lastOperationData || !lastOperationData.record) {
                textElement.textContent = 'Nessuna operazione registrata';
                return;
            }
            
            const record = lastOperationData.record;
            const table = lastOperationData.table;
            
            // Costruisci messaggio come nel sistema Python
            let message = `Il ${record.Data} alle ${record.Ora}, ${record.Operatore || 'Sistema'}`;
            
            // Trova prodotti con quantità > 0
            const prodotti = [];
            Object.keys(record).forEach(key => {
                if (!['Data', 'Ora', 'Operatore', 'Fatturatore', 'Note', 'ImportoInserito', 'Importo', 'Forme'].includes(key)) {
                    const qty = parseFloat(record[key]);
                    if (qty > 0) {
                        prodotti.push(`${qty} ${key.replace(/_/g, ' ')}`);
                    }
                }
            });
            
            // Messaggio specifico per tipo operazione
            if (table === 'vendite') {
                message += prodotti.length > 0 ? ` ha venduto ${prodotti.join(', ')}.` : ' ha effettuato una vendita.';
                if (record.ImportoInserito) {
                    message += ` Importo: €${record.ImportoInserito}`;
                }
            } else if (table === 'fatturato') {
                const fatturatore = record.Fatturatore || 'cliente';
                message += prodotti.length > 0 ? ` ha fatturato ${prodotti.join(', ')} a ${fatturatore}.` : ` ha fatturato a ${fatturatore}.`;
            } else if (table === 'prodotti_aggiunti') {
                message += prodotti.length > 0 ? ` ha aggiunto ${prodotti.join(', ')}.` : ' ha aggiunto prodotti.';
            } else if (table === 'soldi') {
                message += ` ha inserito €${record.Importo} in cassa.`;
            } else if (table === 'produzione_cella_frigo') {
                message += ` ha aggiunto ${record.Forme} forme in cella frigo.`;
            }
            
            if (record.Note) {
                message += ` Note: ${record.Note}`;
            }
            
            textElement.textContent = message;
        }

        async function deleteLastOperation() {
            if (!lastOperationData || !lastOperationData.record) {
                showStatus('Nessuna operazione da eliminare', 'error');
                return;
            }
            
            if (!confirm('Sei sicuro di voler eliminare l\'ultima operazione?')) {
                return;
            }
            
            try {
                showStatus('Eliminazione ultima operazione...', 'info');
                
                // Carica dati tabella
                const data = await readCSV(lastOperationData.table);
                
                // Rimuovi ultimo record
                data.pop();
                
                // Salva
                await writeCSV(lastOperationData.table, data);
                
                showStatus('Ultima operazione eliminata! ✅', 'success');
                
                // Ricarica ultima operazione
                await loadLastOperation();
                
                setTimeout(hideStatus, 2000);
                
            } catch (error) {
                console.error('Errore eliminazione:', error);
                showStatus('Errore durante eliminazione', 'error');
            }
        }

        // ==========================================
        // NAVIGAZIONE
        // ==========================================
        function hideAll() {
            const sections = ['loading', 'operator-selection', 'main-menu', 'vendite', 'fatturazione', 'prodotti-aggiunti', 'cella-frigo', 'magazzino', 'soldi-inseriti'];
            sections.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById('cart').classList.add('hidden');
        }

        function showOperatorSelection() {
            hideAll();
            document.getElementById('operator-selection').classList.remove('hidden');
            document.getElementById('user-info').textContent = 'Seleziona operatore per iniziare';
        }

        function showMainMenu() {
            hideAll();
            document.getElementById('main-menu').classList.remove('hidden');
            resetCart();
        }

        function selectOperator(name) {
            currentOperator = name;
            document.getElementById('user-info').textContent = `Operatore: ${name}`;
            showStatus(`Benvenuto, ${name}! 👋`, 'success');
            setTimeout(() => {
                hideStatus();
                showMainMenu();
            }, 1500);
        }

        // ==========================================
        // SEZIONI PRINCIPALI
        // ==========================================
        function showVendite() {
            currentMode = 'vendite';
            hideAll();
            generateProducts('products-vendite', products);
            document.getElementById('vendite').classList.remove('hidden');
            document.getElementById('cart').classList.remove('hidden');
            
            // Mostra campo importo
            document.getElementById('importo').style.display = 'block';
            resetCart();
        }

        function showFatturazione() {
            currentMode = 'fatturazione';
            hideAll();
            generateProducts('products-fatturazione', products);
            document.getElementById('fatturazione').classList.remove('hidden');
            document.getElementById('cart').classList.remove('hidden');
            
            // Nascondi campo importo per fatturazione
            document.getElementById('importo').style.display = 'none';
            resetCart();
            resetFatturatore();
        }

        function showProdottiAggiunti() {
            currentMode = 'prodotti-aggiunti';
            hideAll();
            generateProducts('products-aggiunti', productsAggiunti);
            document.getElementById('prodotti-aggiunti').classList.remove('hidden');
            document.getElementById('cart').classList.remove('hidden');
            
            // Nascondi campo importo
            document.getElementById('importo').style.display = 'none';
            resetCart();
        }

        function showSoldiInseriti() {
            currentMode = 'soldi-inseriti';
            hideAll();
            document.getElementById('soldi-inseriti').classList.remove('hidden');
            document.getElementById('soldi-importo').value = '';
        }

        function showCellaFrigo() {
            currentMode = 'cella-frigo';
            hideAll();
            document.getElementById('cella-frigo').classList.remove('hidden');
            
            // Reset contatori
            document.getElementById('forme-count').value = 0;
            document.getElementById('ricotta-count').value = 0;
            
            // Carica statistiche
            refreshCellaStats();
        }

        async function showMagazzino() {
            hideAll();
            document.getElementById('magazzino').classList.remove('hidden');
            
            try {
                showStatus('Caricamento dati magazzino...', 'info');
                
                // Carica tutti i dati necessari
                const vendite = await readCSV('vendite');
                const fatturato = await readCSV('fatturato');
                const aggiunti = await readCSV('prodotti_aggiunti');
                
                // Calcola bilancio per ogni prodotto
                const bilancio = {};
                
                // Inizializza con 0
                productsAggiunti.forEach(product => {
                    bilancio[product] = 0;
                });
                
                // Aggiungi prodotti aggiunti
                aggiunti.forEach(record => {
                    Object.keys(record).forEach(key => {
                        if (bilancio.hasOwnProperty(key)) {
                            bilancio[key] += parseFloat(record[key]) || 0;
                        }
                    });
                });
                
                // Sottrai vendite e fatturato
                [...vendite, ...fatturato].forEach(record => {
                    Object.keys(record).forEach(key => {
                        if (bilancio.hasOwnProperty(key)) {
                            bilancio[key] -= parseFloat(record[key]) || 0;
                        }
                    });
                });
                
                // Genera HTML
                let html = '<div class="products-grid">';
                Object.entries(bilancio).forEach(([product, qty]) => {
                    const colorClass = qty < 0 ? 'style="color: #ff6b6b;"' : qty === 0 ? 'style="color: #ffd93d;"' : 'style="color: #6bcf7f;"';
                    html += `
                        <div class="product-card">
                            <div class="product-name">${product.replace(/_/g, ' ')}</div>
                            <div ${colorClass} style="font-size: 2em; font-weight: bold; margin: 20px 0;">
                                ${qty}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                document.getElementById('magazzino-content').innerHTML = html;
                hideStatus();
                
            } catch (error) {
                console.error('Errore caricamento magazzino:', error);
                showStatus('Errore caricamento magazzino', 'error');
            }
        }

        // ==========================================
        // GESTIONE PRODOTTI
        // ==========================================
        function generateProducts(containerId, productList) {
            const container = document.getElementById(containerId);
            container.innerHTML = productList.map(product => `
                <div class="product-card">
                    <div class="product-name">${product.replace(/_/g, ' ').replace(/([a-z])([A-Z])/g, '$1 $2')}</div>
                    <div class="quantity-controls">
                        <button class="btn btn-danger" onclick="updateQuantity('${product}', -1)">-</button>
                        <input type="number" class="quantity-display" id="qty-${product}" value="0" readonly>
                        <button class="btn btn-success" onclick="updateQuantity('${product}', 1)">+</button>
                    </div>
                </div>
            `).join('');
        }

        function updateQuantity(product, delta) {
            if (!cart[product]) cart[product] = 0;
            cart[product] = Math.max(0, cart[product] + delta);
            
            const input = document.getElementById(`qty-${product}`);
            if (input) {
                input.value = cart[product];
            }
            
            updateCartDisplay();
        }

        function updateCartDisplay() {
            const cartItems = document.getElementById('cart-items');
            const items = Object.entries(cart).filter(([_, qty]) => qty > 0);
            
            if (items.length === 0) {
                cartItems.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Carrello vuoto</div>';
            } else {
                cartItems.innerHTML = items.map(([product, qty]) => `
                    <div class="cart-item">
                        <span>${qty}x ${product.replace(/_/g, ' ')}</span>
                        <span style="color: #87CEEB;">${qty}</span>
                    </div>
                `).join('');
            }
        }

        function resetCart() {
            cart = {};
            updateCartDisplay();
            
            // Reset inputs
            const importoInput = document.getElementById('importo');
            const noteInput = document.getElementById('note');
            
            if (importoInput) importoInput.value = '';
            if (noteInput) noteInput.value = '';
            
            // Reset quantity displays
            products.forEach(product => {
                const input = document.getElementById(`qty-${product}`);
                if (input) input.value = 0;
            });
            
            productsAggiunti.forEach(product => {
                const input = document.getElementById(`qty-${product}`);
                if (input) input.value = 0;
            });
        }

        // ==========================================
        // GESTIONE FATTURATORE
        // ==========================================
        function selectFatturatore(nome) {
            selectedFatturatore = nome;
            resetFatturatore();
            
            // Evidenzia il fatturatore selezionato
            const cards = document.querySelectorAll('.fatturatore-card');
            cards.forEach(card => {
                card.classList.remove('selected');
                if (card.textContent === nome) {
                    card.classList.add('selected');
                }
            });
        }

        function resetFatturatore() {
            const cards = document.querySelectorAll('.fatturatore-card');
            cards.forEach(card => card.classList.remove('selected'));
            selectedFatturatore = '';
        }

        // ==========================================
        // GESTIONE CELLA FRIGO
        // ==========================================
        function adjustCellaCount(type, delta) {
            const input = document.getElementById(`${type}-count`);
            const currentValue = parseInt(input.value) || 0;
            const newValue = Math.max(0, currentValue + delta);
            input.value = newValue;
        }

        async function refreshCellaStats() {
            try {
                // Carica dati produzione e prelievi
                const produzione = await readCSV('produzione_cella_frigo');
                const vendite = await readCSV('vendite');
                const fatturato = await readCSV('fatturato');
                
                // Calcola forme prodotte
                let formeProdotte = 0;
                produzione.forEach(record => {
                    formeProdotte += parseFloat(record.Forme) || 0;
                });
                
                // Calcola forme prelevate (Formaggio + Forma_Stagionata)
                let formePrelevate = 0;
                [...vendite, ...fatturato].forEach(record => {
                    formePrelevate += (parseFloat(record.Formaggio) || 0);
                    formePrelevate += (parseFloat(record.Forma_Stagionata) || 0);
                });
                
                const formeDisponibili = Math.max(0, formeProdotte - formePrelevate);
                
                document.getElementById('cella-stats-content').innerHTML = `
                    <div class="stat-item">Forme Prodotte: <strong>${formeProdotte}</strong></div>
                    <div class="stat-item">Forme Prelevate: <strong>${formePrelevate}</strong></div>
                    <div class="stat-item" style="color: #87CEEB; font-size: 1.2em;">
                        Forme Disponibili: <strong>${formeDisponibili}</strong>
                    </div>
                `;
                
            } catch (error) {
                console.error('Errore calcolo statistiche cella:', error);
                document.getElementById('cella-stats-content').innerHTML = 'Errore caricamento statistiche';
            }
        }

        async function registraProduzione() {
            const formeCount = parseInt(document.getElementById('forme-count').value) || 0;
            const ricottaCount = parseInt(document.getElementById('ricotta-count').value) || 0;
            
            if (formeCount === 0 && ricottaCount === 0) {
                showStatus('Inserisci almeno una quantità', 'error');
                return;
            }

            try {
                showStatus('Registrando produzione...', 'info');
                
                const now = new Date();
                const data = now.toLocaleDateString('it-IT');
                const ora = now.toLocaleTimeString('it-IT');

                // Registra forme in cella frigo
                if (formeCount > 0) {
                    await appendToCSV('produzione_cella_frigo', {
                        Data: data,
                        Ora: ora,
                        Forme: formeCount
                    });
                }

                // Registra ricotta nei prodotti aggiunti
                if (ricottaCount > 0) {
                    const ricottaRecord = {
                        Data: data,
                        Ora: ora,
                        Operatore: 'Sistema'
                    };
                    
                    // Inizializza tutti i prodotti a 0
                    productsAggiunti.forEach(product => {
                        ricottaRecord[product] = (product === 'Ricotta') ? ricottaCount : 0;
                    });
                    
                    await appendToCSV('prodotti_aggiunti', ricottaRecord);
                }

                showStatus('Produzione registrata con successo! 🎉', 'success');
                
                // Reset contatori
                document.getElementById('forme-count').value = 0;
                document.getElementById('ricotta-count').value = 0;
                
                // Aggiorna statistiche
                await refreshCellaStats();
                
                // Ricarica ultima operazione
                await loadLastOperation();
                
                setTimeout(() => {
                    hideStatus();
                    showOperatorSelection();
                }, 2000);

            } catch (error) {
                console.error('Errore registrazione produzione:', error);
                showStatus('Errore durante la registrazione', 'error');
            }
        }

        // ==========================================
        // GESTIONE SOLDI
        // ==========================================
        async function confermaSoldi() {
            const importo = parseFloat(document.getElementById('soldi-importo').value);
            
            if (!importo || importo <= 0) {
                showStatus('Inserisci un importo valido', 'error');
                return;
            }
            
            try {
                showStatus('Registrando inserimento...', 'info');
                
                const now = new Date();
                const data = now.toLocaleDateString('it-IT');
                const ora = now.toLocaleTimeString('it-IT');
                
                await appendToCSV('soldi', {
                    Data: data,
                    Ora: ora,
                    Importo: importo.toFixed(2)
                });
                
                showStatus(`€${importo.toFixed(2)} inseriti in cassa! 💰`, 'success');
                
                // Ricarica ultima operazione
                await loadLastOperation();
                
                setTimeout(() => {
                    hideStatus();
                    showMainMenu();
                }, 2000);
                
            } catch (error) {
                console.error('Errore registrazione soldi:', error);
                showStatus('Errore durante la registrazione', 'error');
            }
        }

        // ==========================================
        // CONFERMA OPERAZIONI
        // ==========================================
        async function confermaOperazione() {
            // Validazioni
            if (Object.values(cart).every(qty => qty === 0)) {
                showStatus('Seleziona almeno un prodotto', 'error');
                return;
            }

            if (currentMode === 'fatturazione' && !selectedFatturatore) {
                showStatus('Seleziona un fatturatore', 'error');
                return;
            }

            try {
                showStatus('Salvando operazione...', 'info');

                const now = new Date();
                const data = now.toLocaleDateString('it-IT');
                const ora = now.toLocaleTimeString('it-IT');
                const note = document.getElementById('note').value || '';
                const importo = parseFloat(document.getElementById('importo').value) || 0;

                const record = {
                    Data: data,
                    Ora: ora,
                    Operatore: currentOperator
                };

                // Aggiungi prodotti (inizializza tutti a 0, poi imposta quantità)
                const productList = currentMode === 'prodotti-aggiunti' ? productsAggiunti : products;
                productList.forEach(product => {
                    record[product] = cart[product] || 0;
                });

                // Aggiungi note
                if (note) record.Note = note;

                // Aggiungi campi specifici per tipo operazione
                if (currentMode === 'vendite') {
                    if (importo > 0) record.ImportoInserito = importo;
                    await appendToCSV('vendite', record);
                } else if (currentMode === 'fatturazione') {
                    record.Fatturatore = selectedFatturatore;
                    await appendToCSV('fatturato', record);
                } else if (currentMode === 'prodotti-aggiunti') {
                    await appendToCSV('prodotti_aggiunti', record);
                }

                showStatus(`${currentMode} salvata con successo! 🎉`, 'success');
                
                // Ricarica ultima operazione
                await loadLastOperation();
                
                setTimeout(() => {
                    hideStatus();
                    resetCart();
                    showMainMenu();
                }, 2000);

            } catch (error) {
                console.error('Errore salvataggio:', error);
                showStatus('Errore durante il salvataggio', 'error');
            }
        }

        // ==========================================
        // TASTIERA VIRTUALE
        // ==========================================
        function showVirtualKeyboard(targetId) {
            keyboardTarget = targetId;
            const keyboard = document.getElementById('virtual-keyboard');
            const input = document.getElementById('keyboard-input');
            const targetInput = document.getElementById(targetId);
            
            if (targetInput) {
                input.value = targetInput.value;
            }
            
            keyboard.classList.add('show');
            input.focus();
        }

        function hideVirtualKeyboard() {
            const keyboard = document.getElementById('virtual-keyboard');
            keyboard.classList.remove('show');
            keyboardTarget = null;
        }

        function addToKeyboard(char) {
            const input = document.getElementById('keyboard-input');
            input.value += char;
        }

        function keyboardBackspace() {
            const input = document.getElementById('keyboard-input');
            input.value = input.value.slice(0, -1);
        }

        function confirmKeyboard() {
            const input = document.getElementById('keyboard-input');
            const targetInput = document.getElementById(keyboardTarget);
            
            if (targetInput) {
                targetInput.value = input.value;
            }
            
            hideVirtualKeyboard();
        }

        // ==========================================
        // GESTIONE STATUS MESSAGES
        // ==========================================
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.classList.remove('hidden');
        }

        function hideStatus() {
            const statusDiv = document.getElementById('status-message');
            statusDiv.classList.add('hidden');
        }

        // ==========================================
        // AVVIO APPLICAZIONE
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

        // Gestore eventi per tastiera fisica
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideVirtualKeyboard();
            }
        });
    </script>
</body>
</html>