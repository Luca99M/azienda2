<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Medei Caseificio - Mobile Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e293b, #334155);
            color: white;
            min-height: 100vh;
            padding-bottom: 80px;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0;
            padding: 15px;
            padding-bottom: 100px;
        }

        /* HEADER COMPATTO */
        .header {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            padding: 20px 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* CONFIGURAZIONE */
        .config-section {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            border-radius: 15px;
            padding: 20px 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .config-section h3 {
            color: #fca5a5;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .config-section p {
            color: #fed7d7;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .config-section code {
            background: rgba(0,0,0,0.3);
            padding: 3px 6px;
            border-radius: 4px;
            color: #fbbf24;
            font-size: 0.8em;
        }

        /* BOTTOM NAVIGATION */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(59, 130, 246, 0.3);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 12px;
            min-width: 60px;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        .nav-item.active {
            background: rgba(59, 130, 246, 0.3);
        }

        .nav-icon {
            font-size: 1.8em;
            margin-bottom: 4px;
            transition: all 0.3s ease;
        }

        .nav-item.active .nav-icon {
            transform: scale(1.1);
        }

        .nav-label {
            font-size: 0.7em;
            font-weight: 600;
            text-align: center;
            line-height: 1.2;
        }

        /* PAGES */
        .page {
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .page.active {
            display: block;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* CARDS MOBILE */
        .cards-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .cards-grid.two-col {
            grid-template-columns: 1fr 1fr;
        }

        .card {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .card:active {
            transform: scale(0.98);
        }

        .card h3 {
            color: #60a5fa;
            margin-bottom: 15px;
            font-size: 1.1em;
            text-align: center;
        }

        /* STAT CARDS */
        .stat-card {
            text-align: center;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1));
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: bold;
            background: linear-gradient(135deg, #3b82f6, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #94a3b8;
            line-height: 1.3;
        }

        /* CHART CONTAINERS MOBILE */
        .chart-container {
            height: 250px;
            position: relative;
            margin-top: 10px;
        }

        .chart-container.large {
            height: 300px;
        }

        .chart-container.small {
            height: 200px;
        }

        canvas {
            background: rgba(15, 23, 42, 0.5) !important;
            border-radius: 10px;
        }

        /* FILTERS MOBILE */
        .filters {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            padding: 20px 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .filters h3 {
            color: #60a5fa;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.1em;
        }

        .filter-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            color: #94a3b8;
            font-size: 0.9em;
            font-weight: 600;
        }

        .filter-input, .filter-select {
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(59, 130, 246, 0.3);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            width: 100%;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
        }

        .filter-button {
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .filter-button:active {
            transform: scale(0.98);
        }

        /* LOADING */
        .loading {
            text-align: center;
            padding: 40px 20px;
            font-size: 1.1em;
            color: #94a3b8;
        }

        .loading::after {
            content: "...";
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: "..."; }
            40% { content: "."; }
            60% { content: ".."; }
            80%, 100% { content: "..."; }
        }

        /* STATUS MESSAGES */
        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            color: #fca5a5;
            font-size: 0.9em;
        }

        .success {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid #10b981;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            color: #6ee7b7;
            font-size: 0.9em;
        }

        /* PAGE TITLE MOBILE */
        .page-title {
            text-align: center;
            color: #60a5fa;
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 15px;
        }

        /* STOCK DETAILS */
        .stock-details {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .stock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(94, 167, 248, 0.2);
        }

        .stock-item:last-child {
            border-bottom: none;
        }

        .stock-name {
            color: #94a3b8;
            font-weight: 600;
        }

        .stock-value {
            color: #10b981;
            font-weight: bold;
            font-size: 1.1em;
        }

        /* RESPONSIVE TWEAKS */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .cards-grid.two-col {
                grid-template-columns: 1fr;
            }
            
            .stat-value {
                font-size: 2em;
            }
            
            .chart-container {
                height: 220px;
            }
            
            .nav-icon {
                font-size: 1.6em;
            }
            
            .nav-label {
                font-size: 0.65em;
            }
        }

        /* LANDSCAPE MOBILE */
        @media (max-height: 500px) and (orientation: landscape) {
            .bottom-nav {
                padding: 5px 0;
            }
            
            .nav-item {
                padding: 5px 8px;
            }
            
            .nav-icon {
                font-size: 1.4em;
                margin-bottom: 2px;
            }
            
            .nav-label {
                font-size: 0.6em;
            }
            
            .stat-card {
                min-height: 100px;
            }
        }

        /* SAFE AREA per iPhone */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .bottom-nav {
                padding-bottom: calc(10px + env(safe-area-inset-bottom));
            }
            
            body {
                padding-bottom: calc(80px + env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>🧀 Medei Caseificio</h1>
            <div class="subtitle">Dashboard Mobile - Magazzino Corretto</div>
        </div>

        <!-- CONFIGURAZIONE -->
        <div id="config-section" class="config-section">
            <h3>🔧 CONFIGURAZIONE SUPABASE</h3>
            <p><strong>⚠️ INSERISCI LE TUE CREDENZIALI:</strong></p>
            <p>1. Sostituisci <code>TUA_SUPABASE_URL</code></p>
            <p>2. Sostituisci <code>TUA_SUPABASE_ANON_KEY</code></p>
            <p>3. Assicurati di aver eseguito l'SQL</p>
        </div>

        <!-- PAGE 1: DASHBOARD PRINCIPALE -->
        <div id="dashboard" class="page active">
            <div class="page-title">📊 Dashboard Principale</div>
            
            <!-- STATISTICHE PRINCIPALI -->
            <div class="cards-grid two-col">
                <div class="card stat-card">
                    <h3>🧀 Forme Vendute</h3>
                    <div class="stat-value" id="total-forms">0</div>
                    <div class="stat-label">Totali</div>
                </div>

                <div class="card stat-card">
                    <h3>💰 Incassi</h3>
                    <div class="stat-value" id="total-revenue">€0</div>
                    <div class="stat-label">Totali</div>
                </div>

                <div class="card stat-card">
                    <h3>🏪 In Cella</h3>
                    <div class="stat-value" id="forms-in-cellar">0</div>
                    <div class="stat-label">Forme ora</div>
                </div>

                <div class="card stat-card">
                    <h3>📦 Oggi</h3>
                    <div class="stat-value" id="today-operations">0</div>
                    <div class="stat-label">Operazioni</div>
                </div>
            </div>

            <!-- GRAFICI -->
            <div class="cards-grid">
                <div class="card">
                    <h3>👨‍💼 Operazioni per Operatore</h3>
                    <div class="chart-container">
                        <canvas id="operators-operations-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>💳 Tipologie Operazioni</h3>
                    <div class="chart-container">
                        <canvas id="operations-types-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>📈 Trend Ultimi 7 Giorni (4 Categorie)</h3>
                    <div class="chart-container">
                        <canvas id="recent-trend-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>🥇 Top Prodotti</h3>
                    <div class="chart-container">
                        <canvas id="top-products-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE 2: MAGAZZINO DETTAGLIATO -->
        <div id="inventory" class="page">
            <div class="page-title">📦 Magazzino Dettagliato</div>
            
            <!-- STOCK CORRENTE DETTAGLIATO -->
            <div class="stock-details">
                <h3 style="color: #60a5fa; text-align: center; margin-bottom: 20px;">📊 Stock Attuale (Calcoli Corretti)</h3>
                <div id="detailed-stock"></div>
            </div>

            <!-- GRAFICI MAGAZZINO -->
            <div class="cards-grid">
                <div class="card">
                    <h3>🏪 Stock Principale</h3>
                    <div class="chart-container large">
                        <canvas id="main-stock-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>🛢️ Oli (Tutti i Formati)</h3>
                    <div class="chart-container">
                        <canvas id="oils-stock-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>🥜 Noci & Altri</h3>
                    <div class="chart-container">
                        <canvas id="nuts-stock-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>📊 Movimento Magazzino (7gg)</h3>
                    <div class="chart-container large">
                        <canvas id="inventory-movement-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE 3: ANALISI TEMPORALE -->
        <div id="temporal" class="page">
            <div class="page-title">📅 Analisi Temporale</div>
            
            <div class="filters">
                <h3>🗓️ Selezione Periodo</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Data Inizio</label>
                        <input type="date" id="start-date" class="filter-input">
                    </div>
                    <div class="filter-group">
                        <label>Data Fine</label>
                        <input type="date" id="end-date" class="filter-input">
                    </div>
                    <div class="filter-group">
                        <label>Periodo Rapido</label>
                        <select id="quick-period" class="filter-select">
                            <option value="">Seleziona periodo</option>
                            <option value="today">Oggi</option>
                            <option value="yesterday">Ieri</option>
                            <option value="last7">Ultimi 7 giorni</option>
                            <option value="last30">Ultimi 30 giorni</option>
                            <option value="thisMonth">Questo mese</option>
                        </select>
                    </div>
                    <button class="filter-button" onclick="applyTemporalFilter()">
                        📊 Analizza Periodo
                    </button>
                </div>
            </div>

            <!-- STATISTICHE PERIODO -->
            <div class="cards-grid two-col">
                <div class="card stat-card">
                    <h3>🎯 Operazioni</h3>
                    <div class="stat-value" id="period-operations">0</div>
                    <div class="stat-label">Nel periodo</div>
                </div>

                <div class="card stat-card">
                    <h3>💰 Ricavi</h3>
                    <div class="stat-value" id="period-revenue">€0</div>
                    <div class="stat-label">Nel periodo</div>
                </div>
            </div>

            <!-- GRAFICI TEMPORALI -->
            <div class="cards-grid">
                <div class="card">
                    <h3>📊 4 Categorie nel Periodo</h3>
                    <div class="chart-container large">
                        <canvas id="temporal-categories-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>📅 Andamento Giornaliero</h3>
                    <div class="chart-container large">
                        <canvas id="temporal-daily-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE 4: PERFORMANCE OPERATORI -->
        <div id="operators" class="page">
            <div class="page-title">👨‍💼 Performance Operatori</div>
            
            <div class="cards-grid">
                <div class="card">
                    <h3>👨‍💼 Operazioni per Operatore (4 Categorie)</h3>
                    <div class="chart-container large">
                        <canvas id="operators-categories-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>⏰ Performance Oraria</h3>
                    <div class="chart-container large">
                        <canvas id="hourly-performance-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>📊 Distribuzione Operatori</h3>
                    <div class="chart-container">
                        <canvas id="operators-distribution-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>💰 Ricavi per Operatore</h3>
                    <div class="chart-container">
                        <canvas id="operators-revenue-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- STATUS MESSAGE -->
        <div id="status-message"></div>
    </div>

    <!-- BOTTOM NAVIGATION -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="showPage('dashboard')">
            <div class="nav-icon">📊</div>
            <div class="nav-label">Dashboard</div>
        </div>
        <div class="nav-item" onclick="showPage('inventory')">
            <div class="nav-icon">📦</div>
            <div class="nav-label">Magazzino</div>
        </div>
        <div class="nav-item" onclick="showPage('temporal')">
            <div class="nav-icon">📅</div>
            <div class="nav-label">Temporale</div>
        </div>
        <div class="nav-item" onclick="showPage('operators')">
            <div class="nav-icon">👨‍💼</div>
            <div class="nav-label">Operatori</div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURAZIONE SUPABASE
        // ==========================================
        const SUPABASE_URL = 'TUA_SUPABASE_URL';  // SOSTITUISCI CON LA TUA URL
        const SUPABASE_ANON_KEY = 'TUA_SUPABASE_ANON_KEY'; // SOSTITUISCI CON LA TUA KEY

        // Controlla configurazione
        if (SUPABASE_URL === 'TUA_SUPABASE_URL' || SUPABASE_ANON_KEY === 'TUA_SUPABASE_ANON_KEY') {
            document.getElementById('config-section').style.display = 'block';
            showError('⚠️ Configurazione Supabase richiesta! Modifica le credenziali nel codice.');
        } else {
            document.getElementById('config-section').style.display = 'none';
        }

        // Inizializza Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ==========================================
        // VARIABILI GLOBALI E CATEGORIE
        // ==========================================
        let allData = {
            vendite: [],
            fatturato: [],
            prodotti_aggiunti: [],
            produzione_cella_frigo: [],
            soldi: []
        };
        let activeCharts = {};

        // COLORI PER LE 4 CATEGORIE
        const CATEGORY_COLORS = {
            vendite: '#10b981',     // Verde per vendite
            bancomat: '#3b82f6',    // Blu per bancomat
            regalo: '#f59e0b',      // Arancione per regali
            grossisti: '#8b5cf6'    // Viola per grossisti
        };

        // LISTA COMPLETA DEI PRODOTTI
        const ALL_PRODUCTS = [
            'formaggio', 'forma_stagionata', 'ricotta', 'miele', 
            'noci_1kg', 'noci_3kg', 
            'olio_025l', 'olio_05l', 'olio_075l', 'olio_1l', 'olio_2l', 'olio_3l', 'olio_5l',
            'grattugiato'
        ];

        // ==========================================
        // FUNZIONI CALCOLO STOCK CORRETTE
        // ==========================================
        function calculateCorrectStock() {
            const stock = {};
            
            // Inizializza tutti i prodotti a 0
            ALL_PRODUCTS.forEach(product => {
                stock[product] = 0;
            });

            console.log('🔍 Calcolo stock iniziato...');

            // 1. AGGIUNGI dal magazzino (prodotti_aggiunti)
            allData.prodotti_aggiunti.forEach(record => {
                ALL_PRODUCTS.forEach(product => {
                    const value = parseFloat(record[product]) || 0;
                    if (value > 0) {
                        stock[product] += value;
                        console.log(`➕ Aggiunto ${product}: +${value} (totale: ${stock[product]})`);
                    }
                });
            });

            console.log('📊 Stock dopo aggiunte:', {...stock});

            // 2. SOTTRAI dalle vendite
            allData.vendite.forEach(record => {
                ALL_PRODUCTS.forEach(product => {
                    const value = parseFloat(record[product]) || 0;
                    if (value > 0) {
                        stock[product] -= value;
                        console.log(`➖ Venduto ${product}: -${value} (totale: ${stock[product]})`);
                    }
                });
                
                // Gestisci mezza_forma (0.5 formaggio)
                const mezzaForma = parseFloat(record.mezza_forma) || 0;
                if (mezzaForma > 0) {
                    stock.formaggio -= (mezzaForma * 0.5);
                    console.log(`➖ Venduto mezza_forma: -${mezzaForma * 0.5} formaggio (totale: ${stock.formaggio})`);
                }
                
                // Gestisci mezzaforma_stag (0.5 forma_stagionata)
                const mezzaStag = parseFloat(record.mezzaforma_stag) || 0;
                if (mezzaStag > 0) {
                    stock.forma_stagionata -= (mezzaStag * 0.5);
                    console.log(`➖ Venduto mezzaforma_stag: -${mezzaStag * 0.5} forma_stagionata (totale: ${stock.forma_stagionata})`);
                }
            });

            console.log('📊 Stock dopo vendite:', {...stock});

            // 3. SOTTRAI dal fatturato
            allData.fatturato.forEach(record => {
                ALL_PRODUCTS.forEach(product => {
                    const value = parseFloat(record[product]) || 0;
                    if (value > 0) {
                        stock[product] -= value;
                        console.log(`➖ Fatturato ${product}: -${value} (totale: ${stock[product]})`);
                    }
                });
                
                // Gestisci mezza_forma dal fatturato
                const mezzaForma = parseFloat(record.mezza_forma) || 0;
                if (mezzaForma > 0) {
                    stock.formaggio -= (mezzaForma * 0.5);
                    console.log(`➖ Fatturato mezza_forma: -${mezzaForma * 0.5} formaggio (totale: ${stock.formaggio})`);
                }
                
                // Gestisci mezzaforma_stag dal fatturato
                const mezzaStag = parseFloat(record.mezzaforma_stag) || 0;
                if (mezzaStag > 0) {
                    stock.forma_stagionata -= (mezzaStag * 0.5);
                    console.log(`➖ Fatturato mezzaforma_stag: -${mezzaStag * 0.5} forma_stagionata (totale: ${stock.forma_stagionata})`);
                }
            });

            console.log('📊 Stock finale:', {...stock});

            // Assicurati che non ci siano valori negativi (stock minimo 0)
            Object.keys(stock).forEach(product => {
                if (stock[product] < 0) {
                    console.warn(`⚠️ Stock negativo per ${product}: ${stock[product]}, impostato a 0`);
                    stock[product] = 0;
                }
                // Arrotonda a 2 decimali
                stock[product] = Math.round(stock[product] * 100) / 100;
            });

            return stock;
        }

        function calculateFormsInCellar() {
            const stock = calculateCorrectStock();
            return Math.round(stock.formaggio + stock.forma_stagionata);
        }

        // ==========================================
        // FUNZIONI CATEGORIZZAZIONE
        // ==========================================
        function categorizeOperations(venditeData, fatturatoData) {
            const categories = {
                vendite: venditeData || [],
                bancomat: [],
                regalo: [],
                grossisti: []
            };

            (fatturatoData || []).forEach(record => {
                const fatturatore = (record.fatturatore || '').toLowerCase();
                if (fatturatore === 'bancomat') {
                    categories.bancomat.push(record);
                } else if (fatturatore === 'regalo') {
                    categories.regalo.push(record);
                } else {
                    categories.grossisti.push(record);
                }
            });

            return categories;
        }

        function getOperationCounts(categories) {
            return {
                vendite: categories.vendite.length,
                bancomat: categories.bancomat.length,
                regalo: categories.regalo.length,
                grossisti: categories.grossisti.length
            };
        }

        // ==========================================
        // CARICAMENTO DATI DA SUPABASE
        // ==========================================
        async function loadAllData() {
            try {
                showStatus('📡 Caricamento dati...');
                
                const [venditeRes, fatturatoRes, prodottiRes, produzioneRes, soldiRes] = await Promise.all([
                    supabase.from('vendite').select('*').order('data', { ascending: false }),
                    supabase.from('fatturato').select('*').order('data', { ascending: false }),
                    supabase.from('prodotti_aggiunti').select('*').order('data', { ascending: false }),
                    supabase.from('produzione_cella_frigo').select('*').order('data', { ascending: false }),
                    supabase.from('soldi').select('*').order('data', { ascending: false })
                ]);

                if (venditeRes.error) throw new Error('Vendite: ' + venditeRes.error.message);
                if (fatturatoRes.error) throw new Error('Fatturato: ' + fatturatoRes.error.message);
                if (prodottiRes.error) throw new Error('Prodotti: ' + prodottiRes.error.message);
                if (produzioneRes.error) throw new Error('Produzione: ' + produzioneRes.error.message);
                if (soldiRes.error) throw new Error('Soldi: ' + soldiRes.error.message);

                allData.vendite = venditeRes.data || [];
                allData.fatturato = fatturatoRes.data || [];
                allData.prodotti_aggiunti = prodottiRes.data || [];
                allData.produzione_cella_frigo = produzioneRes.data || [];
                allData.soldi = soldiRes.data || [];

                console.log('✅ Dati caricati:', {
                    vendite: allData.vendite.length,
                    fatturato: allData.fatturato.length,
                    prodotti: allData.prodotti_aggiunti.length,
                    produzione: allData.produzione_cella_frigo.length,
                    soldi: allData.soldi.length
                });

                showSuccess(`✅ ${allData.vendite.length} vendite, ${allData.fatturato.length} fatture caricate`);
                return true;

            } catch (error) {
                console.error('Errore caricamento:', error);
                showError('❌ Errore: ' + error.message);
                return false;
            }
        }

        // ==========================================
        // NAVIGATION MOBILE
        // ==========================================
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(pageId).classList.add('active');
            event.currentTarget.classList.add('active');
            
            loadPageData(pageId);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function loadPageData(pageId) {
            switch(pageId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'inventory':
                    loadInventory();
                    break;
                case 'temporal':
                    loadTemporal();
                    break;
                case 'operators':
                    loadOperators();
                    break;
            }
        }

        // ==========================================
        // DASHBOARD PRINCIPALE
        // ==========================================
        function loadDashboard() {
            if (allData.vendite.length === 0) {
                showError('Nessun dato. Controlla Supabase.');
                return;
            }

            const totalForms = calculateTotalForms();
            const totalRevenue = calculateTotalRevenue();
            const formsInCellar = calculateFormsInCellar();
            const todayOperations = calculateTodayOperations();
            
            document.getElementById('total-forms').textContent = totalForms;
            document.getElementById('total-revenue').textContent = `€${totalRevenue.toLocaleString()}`;
            document.getElementById('forms-in-cellar').textContent = formsInCellar;
            document.getElementById('today-operations').textContent = todayOperations;
            
            // Crea grafici con 4 categorie
            createOperatorsOperationsChart();
            createOperationsTypesChart();
            createRecentTrendChart();
            createTopProductsChart();
        }

        function calculateTotalForms() {
            let total = 0;
            allData.vendite.forEach(record => {
                total += (parseFloat(record.formaggio) || 0) + (parseFloat(record.forma_stagionata) || 0);
                total += (parseFloat(record.mezza_forma) || 0) * 0.5;
                total += (parseFloat(record.mezzaforma_stag) || 0) * 0.5;
            });
            allData.fatturato.forEach(record => {
                total += (parseFloat(record.formaggio) || 0) + (parseFloat(record.forma_stagionata) || 0);
                total += (parseFloat(record.mezza_forma) || 0) * 0.5;
                total += (parseFloat(record.mezzaforma_stag) || 0) * 0.5;
            });
            return Math.round(total);
        }

        function calculateTotalRevenue() {
            let total = 0;
            allData.vendite.forEach(record => {
                total += parseFloat(record.importo_inserito) || 0;
            });
            return Math.round(total);
        }

        function calculateTodayOperations() {
            const today = new Date().toISOString().split('T')[0];
            let operations = 0;
            
            [...allData.vendite, ...allData.fatturato].forEach(record => {
                if (record.data === today) {
                    operations++;
                }
            });
            
            return operations;
        }

        // ==========================================
        // PAGINA MAGAZZINO DETTAGLIATA
        // ==========================================
        function loadInventory() {
            createDetailedStockDisplay();
            createMainStockChart();
            createOilsStockChart();
            createNutsStockChart();
            createInventoryMovementChart();
        }

        function createDetailedStockDisplay() {
            const stock = calculateCorrectStock();
            const container = document.getElementById('detailed-stock');
            
            let html = '';
            
            // Prodotti principali
            const mainProducts = [
                { key: 'formaggio', label: 'Formaggio Fresco', unit: 'forme' },
                { key: 'forma_stagionata', label: 'Forma Stagionata', unit: 'forme' },
                { key: 'ricotta', label: 'Ricotta', unit: 'kg' },
                { key: 'miele', label: 'Miele', unit: 'kg' },
                { key: 'grattugiato', label: 'Grattugiato', unit: 'kg' }
            ];

            mainProducts.forEach(product => {
                const value = stock[product.key] || 0;
                html += `
                    <div class="stock-item">
                        <div class="stock-name">${product.label}</div>
                        <div class="stock-value">${value} ${product.unit}</div>
                    </div>
                `;
            });

            // Oli
            html += '<div style="margin: 20px 0; color: #60a5fa; font-weight: bold;">🛢️ OLI</div>';
            const oils = [
                { key: 'olio_025l', label: 'Olio 0.25L' },
                { key: 'olio_05l', label: 'Olio 0.5L' },
                { key: 'olio_075l', label: 'Olio 0.75L' },
                { key: 'olio_1l', label: 'Olio 1L' },
                { key: 'olio_2l', label: 'Olio 2L' },
                { key: 'olio_3l', label: 'Olio 3L' },
                { key: 'olio_5l', label: 'Olio 5L' }
            ];

            oils.forEach(oil => {
                const value = stock[oil.key] || 0;
                html += `
                    <div class="stock-item">
                        <div class="stock-name">${oil.label}</div>
                        <div class="stock-value">${value} pz</div>
                    </div>
                `;
            });

            // Noci
            html += '<div style="margin: 20px 0; color: #60a5fa; font-weight: bold;">🥜 NOCI</div>';
            const nuts = [
                { key: 'noci_1kg', label: 'Noci 1kg' },
                { key: 'noci_3kg', label: 'Noci 3kg' }
            ];

            nuts.forEach(nut => {
                const value = stock[nut.key] || 0;
                html += `
                    <div class="stock-item">
                        <div class="stock-name">${nut.label}</div>
                        <div class="stock-value">${value} pz</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function createMainStockChart() {
            const ctx = document.getElementById('main-stock-chart');
            if (!ctx) return;
            
            if (activeCharts['main-stock']) {
                activeCharts['main-stock'].destroy();
            }
            
            const stock = calculateCorrectStock();
            const mainProducts = ['formaggio', 'forma_stagionata', 'ricotta', 'miele', 'grattugiato'];
            const labels = ['Formaggio', 'F.Stagionata', 'Ricotta', 'Miele', 'Grattugiato'];
            
            activeCharts['main-stock'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Stock Attuale',
                        data: mainProducts.map(product => stock[product] || 0),
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'],
                        borderWidth: 2,
                        borderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        function createOilsStockChart() {
            const ctx = document.getElementById('oils-stock-chart');
            if (!ctx) return;
            
            if (activeCharts['oils-stock']) {
                activeCharts['oils-stock'].destroy();
            }
            
            const stock = calculateCorrectStock();
            const oils = ['olio_025l', 'olio_05l', 'olio_075l', 'olio_1l', 'olio_2l', 'olio_3l', 'olio_5l'];
            const labels = ['0.25L', '0.5L', '0.75L', '1L', '2L', '3L', '5L'];
            
            activeCharts['oils-stock'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: oils.map(oil => stock[oil] || 0),
                        backgroundColor: [
                            '#10b981', '#3b82f6', '#f59e0b', '#ef4444', 
                            '#8b5cf6', '#06b6d4', '#84cc16'
                        ],
                        borderWidth: 2,
                        borderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function createNutsStockChart() {
            const ctx = document.getElementById('nuts-stock-chart');
            if (!ctx) return;
            
            if (activeCharts['nuts-stock']) {
                activeCharts['nuts-stock'].destroy();
            }
            
            const stock = calculateCorrectStock();
            
            activeCharts['nuts-stock'] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Noci 1kg', 'Noci 3kg'],
                    datasets: [{
                        data: [stock.noci_1kg || 0, stock.noci_3kg || 0],
                        backgroundColor: ['#f59e0b', '#ef4444'],
                        borderWidth: 2,
                        borderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8', font: { size: 11 } }
                        }
                    }
                }
            });
        }

        function createInventoryMovementChart() {
            const ctx = document.getElementById('inventory-movement-chart');
            if (!ctx) return;
            
            if (activeCharts['inventory-movement']) {
                activeCharts['inventory-movement'].destroy();
            }
            
            const days = [];
            const formaggiAggiunti = [];
            const formaggiVenduti = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dayLabel = date.getDate() + '/' + (date.getMonth() + 1);
                const dayISO = date.toISOString().split('T')[0];
                days.push(dayLabel);
                
                let aggiunti = 0;
                let venduti = 0;
                
                allData.prodotti_aggiunti.forEach(record => {
                    if (record.data === dayISO) {
                        aggiunti += parseFloat(record.formaggio) || 0;
                    }
                });
                
                [...allData.vendite, ...allData.fatturato].forEach(record => {
                    if (record.data === dayISO) {
                        venduti += parseFloat(record.formaggio) || 0;
                        venduti += (parseFloat(record.mezza_forma) || 0) * 0.5;
                    }
                });
                
                formaggiAggiunti.push(aggiunti);
                formaggiVenduti.push(-venduti);
            }
            
            activeCharts['inventory-movement'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [
                        {
                            label: 'Aggiunti',
                            data: formaggiAggiunti,
                            backgroundColor: '#10b981'
                        },
                        {
                            label: 'Venduti',
                            data: formaggiVenduti,
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8', font: { size: 11 } }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        // ==========================================
        // GRAFICI DASHBOARD PRINCIPALE
        // ==========================================
        function createOperatorsOperationsChart() {
            const ctx = document.getElementById('operators-operations-chart');
            if (!ctx) return;
            
            if (activeCharts['operators-operations']) {
                activeCharts['operators-operations'].destroy();
            }
            
            const operatorsOps = {};
            
            [...allData.vendite, ...allData.fatturato].forEach(record => {
                const operator = record.operatore;
                if (!operatorsOps[operator]) operatorsOps[operator] = 0;
                operatorsOps[operator]++;
            });
            
            const sortedOperators = Object.entries(operatorsOps).sort((a, b) => b[1] - a[1]);
            const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
            
            activeCharts['operators-operations'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedOperators.map(([name]) => name.substring(0, 8)),
                    datasets: [{
                        label: 'Operazioni Totali',
                        data: sortedOperators.map(([, ops]) => ops),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        function createOperationsTypesChart() {
            const ctx = document.getElementById('operations-types-chart');
            if (!ctx) return;
            
            if (activeCharts['operations-types']) {
                activeCharts['operations-types'].destroy();
            }
            
            const categories = categorizeOperations(allData.vendite, allData.fatturato);
            const counts = getOperationCounts(categories);
            
            activeCharts['operations-types'] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Vendite', 'Bancomat', 'Regalo', 'Grossisti'],
                    datasets: [{
                        data: [counts.vendite, counts.bancomat, counts.regalo, counts.grossisti],
                        backgroundColor: [
                            CATEGORY_COLORS.vendite,
                            CATEGORY_COLORS.bancomat,
                            CATEGORY_COLORS.regalo,
                            CATEGORY_COLORS.grossisti
                        ],
                        borderWidth: 2,
                        borderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { 
                                color: '#94a3b8',
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }

        function createRecentTrendChart() {
            const ctx = document.getElementById('recent-trend-chart');
            if (!ctx) return;
            
            if (activeCharts['recent-trend']) {
                activeCharts['recent-trend'].destroy();
            }
            
            const last7Days = [];
            const dailyData = {
                vendite: [],
                bancomat: [],
                regalo: [],
                grossisti: []
            };
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const dayLabel = date.getDate() + '/' + (date.getMonth() + 1);
                last7Days.push(dayLabel);
                
                let venditeCount = 0;
                let bancomatCount = 0;
                let regaloCount = 0;
                let grossistiCount = 0;
                
                allData.vendite.forEach(record => {
                    if (record.data === dateStr) venditeCount++;
                });
                
                allData.fatturato.forEach(record => {
                    if (record.data === dateStr) {
                        const fatturatore = (record.fatturatore || '').toLowerCase();
                        if (fatturatore === 'bancomat') {
                            bancomatCount++;
                        } else if (fatturatore === 'regalo') {
                            regaloCount++;
                        } else {
                            grossistiCount++;
                        }
                    }
                });
                
                dailyData.vendite.push(venditeCount);
                dailyData.bancomat.push(bancomatCount);
                dailyData.regalo.push(regaloCount);
                dailyData.grossisti.push(grossistiCount);
            }
            
            activeCharts['recent-trend'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [
                        {
                            label: 'Vendite',
                            data: dailyData.vendite,
                            borderColor: CATEGORY_COLORS.vendite,
                            backgroundColor: CATEGORY_COLORS.vendite + '20',
                            tension: 0.4
                        },
                        {
                            label: 'Bancomat',
                            data: dailyData.bancomat,
                            borderColor: CATEGORY_COLORS.bancomat,
                            backgroundColor: CATEGORY_COLORS.bancomat + '20',
                            tension: 0.4
                        },
                        {
                            label: 'Regalo',
                            data: dailyData.regalo,
                            borderColor: CATEGORY_COLORS.regalo,
                            backgroundColor: CATEGORY_COLORS.regalo + '20',
                            tension: 0.4
                        },
                        {
                            label: 'Grossisti',
                            data: dailyData.grossisti,
                            borderColor: CATEGORY_COLORS.grossisti,
                            backgroundColor: CATEGORY_COLORS.grossisti + '20',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { 
                                color: '#94a3b8',
                                font: { size: 10 }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { 
                                color: '#94a3b8',
                                font: { size: 10 }
                            },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { 
                                color: '#94a3b8',
                                font: { size: 10 }
                            },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        function createTopProductsChart() {
            const ctx = document.getElementById('top-products-chart');
            if (!ctx) return;
            
            if (activeCharts['top-products']) {
                activeCharts['top-products'].destroy();
            }
            
            const productSales = {
                'Formaggio': 0,
                'F.Stagionata': 0,
                'Ricotta': 0,
                'Miele': 0,
                'Olio 1L': 0
            };
            
            [...allData.vendite, ...allData.fatturato].forEach(record => {
                productSales['Formaggio'] += parseFloat(record.formaggio) || 0;
                productSales['Formaggio'] += (parseFloat(record.mezza_forma) || 0) * 0.5;
                productSales['F.Stagionata'] += parseFloat(record.forma_stagionata) || 0;
                productSales['F.Stagionata'] += (parseFloat(record.mezzaforma_stag) || 0) * 0.5;
                productSales['Ricotta'] += parseFloat(record.ricotta) || 0;
                productSales['Miele'] += parseFloat(record.miele) || 0;
                productSales['Olio 1L'] += parseFloat(record.olio_1l) || 0;
            });
            
            const sortedProducts = Object.entries(productSales)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            activeCharts['top-products'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedProducts.map(([name]) => name),
                    datasets: [{
                        label: 'Quantità',
                        data: sortedProducts.map(([, value]) => value),
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'],
                        borderWidth: 2,
                        borderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        // ==========================================
        // ANALISI TEMPORALE
        // ==========================================
        function loadTemporal() {
            setupDateFilters();
        }

        function setupDateFilters() {
            const today = new Date();
            const startDate = document.getElementById('start-date');
            const endDate = document.getElementById('end-date');
            
            const lastMonth = new Date();
            lastMonth.setDate(lastMonth.getDate() - 30);
            
            startDate.value = lastMonth.toISOString().split('T')[0];
            endDate.value = today.toISOString().split('T')[0];
            
            document.getElementById('quick-period').addEventListener('change', function() {
                const period = this.value;
                const today = new Date();
                let start = new Date();
                
                switch(period) {
                    case 'today':
                        start = new Date();
                        break;
                    case 'yesterday':
                        start = new Date();
                        start.setDate(start.getDate() - 1);
                        today.setDate(today.getDate() - 1);
                        break;
                    case 'last7':
                        start.setDate(start.getDate() - 7);
                        break;
                    case 'last30':
                        start.setDate(start.getDate() - 30);
                        break;
                    case 'thisMonth':
                        start = new Date(today.getFullYear(), today.getMonth(), 1);
                        break;
                }
                
                startDate.value = start.toISOString().split('T')[0];
                endDate.value = today.toISOString().split('T')[0];
            });
        }

        function applyTemporalFilter() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) {
                showError('Seleziona entrambe le date');
                return;
            }
            
            const filteredData = filterDataByPeriod(startDate, endDate);
            updatePeriodStats(filteredData);
            createTemporalCategoriesChart(filteredData);
            createTemporalDailyChart(filteredData);
        }

        function filterDataByPeriod(startDate, endDate) {
            const filtered = { vendite: [], fatturato: [] };
            
            allData.vendite.forEach(record => {
                if (record.data >= startDate && record.data <= endDate) {
                    filtered.vendite.push(record);
                }
            });
            
            allData.fatturato.forEach(record => {
                if (record.data >= startDate && record.data <= endDate) {
                    filtered.fatturato.push(record);
                }
            });
            
            return filtered;
        }

        function updatePeriodStats(filteredData) {
            const totalOperations = filteredData.vendite.length + filteredData.fatturato.length;
            
            let revenue = 0;
            filteredData.vendite.forEach(record => {
                revenue += parseFloat(record.importo_inserito) || 0;
            });
            
            document.getElementById('period-operations').textContent = totalOperations;
            document.getElementById('period-revenue').textContent = `€${Math.round(revenue).toLocaleString()}`;
        }

        function createTemporalCategoriesChart(filteredData) {
            const ctx = document.getElementById('temporal-categories-chart');
            if (!ctx) return;
            
            if (activeCharts['temporal-categories']) {
                activeCharts['temporal-categories'].destroy();
            }
            
            const categories = categorizeOperations(filteredData.vendite, filteredData.fatturato);
            const counts = getOperationCounts(categories);
            
            activeCharts['temporal-categories'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Vendite', 'Bancomat', 'Regalo', 'Grossisti'],
                    datasets: [{
                        label: 'Operazioni',
                        data: [counts.vendite, counts.bancomat, counts.regalo, counts.grossisti],
                        backgroundColor: [
                            CATEGORY_COLORS.vendite,
                            CATEGORY_COLORS.bancomat,
                            CATEGORY_COLORS.regalo,
                            CATEGORY_COLORS.grossisti
                        ],
                        borderWidth: 2,
                        borderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        function createTemporalDailyChart(filteredData) {
            const ctx = document.getElementById('temporal-daily-chart');
            if (!ctx) return;
            
            if (activeCharts['temporal-daily']) {
                activeCharts['temporal-daily'].destroy();
            }
            
            const dailyCategories = {};
            
            [...filteredData.vendite, ...filteredData.fatturato].forEach(record => {
                const date = new Date(record.data);
                const dayLabel = date.getDate() + '/' + (date.getMonth() + 1);
                
                if (!dailyCategories[dayLabel]) {
                    dailyCategories[dayLabel] = { vendite: 0, bancomat: 0, regalo: 0, grossisti: 0 };
                }
                
                if (filteredData.vendite.includes(record)) {
                    dailyCategories[dayLabel].vendite++;
                } else {
                    const fatturatore = (record.fatturatore || '').toLowerCase();
                    if (fatturatore === 'bancomat') {
                        dailyCategories[dayLabel].bancomat++;
                    } else if (fatturatore === 'regalo') {
                        dailyCategories[dayLabel].regalo++;
                    } else {
                        dailyCategories[dayLabel].grossisti++;
                    }
                }
            });
            
            const sortedDates = Object.keys(dailyCategories).sort();
            
            activeCharts['temporal-daily'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [
                        {
                            label: 'Vendite',
                            data: sortedDates.map(date => dailyCategories[date].vendite),
                            borderColor: CATEGORY_COLORS.vendite,
                            backgroundColor: CATEGORY_COLORS.vendite + '20',
                            tension: 0.4
                        },
                        {
                            label: 'Bancomat',
                            data: sortedDates.map(date => dailyCategories[date].bancomat),
                            borderColor: CATEGORY_COLORS.bancomat,
                            backgroundColor: CATEGORY_COLORS.bancomat + '20',
                            tension: 0.4
                        },
                        {
                            label: 'Regalo',
                            data: sortedDates.map(date => dailyCategories[date].regalo),
                            borderColor: CATEGORY_COLORS.regalo,
                            backgroundColor: CATEGORY_COLORS.regalo + '20',
                            tension: 0.4
                        },
                        {
                            label: 'Grossisti',
                            data: sortedDates.map(date => dailyCategories[date].grossisti),
                            borderColor: CATEGORY_COLORS.grossisti,
                            backgroundColor: CATEGORY_COLORS.grossisti + '20',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8', font: { size: 10 } }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        // ==========================================
        // PERFORMANCE OPERATORI
        // ==========================================
        function loadOperators() {
            createOperatorsCategoriesChart();
            createHourlyPerformanceChart();
            createOperatorsDistributionChart();
            createOperatorsRevenueChart();
        }

        function createOperatorsCategoriesChart() {
            const ctx = document.getElementById('operators-categories-chart');
            if (!ctx) return;
            
            if (activeCharts['operators-categories']) {
                activeCharts['operators-categories'].destroy();
            }
            
            const operatorStats = {};
            
            [...allData.vendite, ...allData.fatturato].forEach(record => {
                const operator = record.operatore;
                if (!operatorStats[operator]) {
                    operatorStats[operator] = { vendite: 0, bancomat: 0, regalo: 0, grossisti: 0 };
                }
            });
            
            allData.vendite.forEach(record => {
                operatorStats[record.operatore].vendite++;
            });
            
            allData.fatturato.forEach(record => {
                const fatturatore = (record.fatturatore || '').toLowerCase();
                if (fatturatore === 'bancomat') {
                    operatorStats[record.operatore].bancomat++;
                } else if (fatturatore === 'regalo') {
                    operatorStats[record.operatore].regalo++;
                } else {
                    operatorStats[record.operatore].grossisti++;
                }
            });
            
            const operators = Object.keys(operatorStats);
            
            activeCharts['operators-categories'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: operators.map(op => op.substring(0, 8)),
                    datasets: [
                        {
                            label: 'Vendite',
                            data: operators.map(op => operatorStats[op].vendite),
                            backgroundColor: CATEGORY_COLORS.vendite
                        },
                        {
                            label: 'Bancomat',
                            data: operators.map(op => operatorStats[op].bancomat),
                            backgroundColor: CATEGORY_COLORS.bancomat
                        },
                        {
                            label: 'Regalo',
                            data: operators.map(op => operatorStats[op].regalo),
                            backgroundColor: CATEGORY_COLORS.regalo
                        },
                        {
                            label: 'Grossisti',
                            data: operators.map(op => operatorStats[op].grossisti),
                            backgroundColor: CATEGORY_COLORS.grossisti
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8', font: { size: 10 } }
                        }
                    },
                    scales: {
                        y: {
                            stacked: true,
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            stacked: true,
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        function createHourlyPerformanceChart() {
            const ctx = document.getElementById('hourly-performance-chart');
            if (!ctx) return;
            
            if (activeCharts['hourly-performance']) {
                activeCharts['hourly-performance'].destroy();
            }
            
            const hours = Array.from({length: 12}, (_, i) => `${i + 8}h`);
            const hourlyData = {};
            
            hours.forEach(hour => hourlyData[hour] = 0);
            
            [...allData.vendite, ...allData.fatturato].forEach(record => {
                if (record.ora) {
                    const hour = record.ora.split(':')[0] + 'h';
                    if (hourlyData[hour] !== undefined) {
                        hourlyData[hour]++;
                    }
                }
            });
            
            activeCharts['hourly-performance'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Operazioni Totali',
                        data: hours.map(hour => hourlyData[hour]),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        function createOperatorsDistributionChart() {
            const ctx = document.getElementById('operators-distribution-chart');
            if (!ctx) return;
            
            if (activeCharts['operators-distribution']) {
                activeCharts['operators-distribution'].destroy();
            }
            
            const operatorsTotalOps = {};
            
            [...allData.vendite, ...allData.fatturato].forEach(record => {
                const operator = record.operatore;
                if (!operatorsTotalOps[operator]) operatorsTotalOps[operator] = 0;
                operatorsTotalOps[operator]++;
            });
            
            const sortedOperators = Object.entries(operatorsTotalOps)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6);
            
            const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
            
            activeCharts['operators-distribution'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedOperators.map(([name]) => name.substring(0, 8)),
                    datasets: [{
                        data: sortedOperators.map(([, ops]) => ops),
                        backgroundColor: colors,
                        borderWidth: 3,
                        borderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8', font: { size: 11 } }
                        }
                    }
                }
            });
        }

        function createOperatorsRevenueChart() {
            const ctx = document.getElementById('operators-revenue-chart');
            if (!ctx) return;
            
            if (activeCharts['operators-revenue']) {
                activeCharts['operators-revenue'].destroy();
            }
            
            const operatorsRevenue = {};
            
            allData.vendite.forEach(record => {
                const operator = record.operatore;
                const revenue = parseFloat(record.importo_inserito) || 0;
                if (!operatorsRevenue[operator]) operatorsRevenue[operator] = 0;
                operatorsRevenue[operator] += revenue;
            });
            
            const sortedRevenue = Object.entries(operatorsRevenue)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            activeCharts['operators-revenue'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedRevenue.map(([name]) => name.substring(0, 8)),
                    datasets: [{
                        label: 'Ricavi €',
                        data: sortedRevenue.map(([, revenue]) => Math.round(revenue)),
                        backgroundColor: CATEGORY_COLORS.vendite,
                        borderWidth: 2,
                        borderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: { 
                                color: '#94a3b8', 
                                font: { size: 10 },
                                callback: function(value) {
                                    return '€' + value.toLocaleString();
                                }
                            },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        function showStatus(message) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.innerHTML = `<div class="loading">${message}</div>`;
        }

        function showSuccess(message) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.innerHTML = `<div class="success">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        function showError(message) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.innerHTML = `<div class="error">${message}</div>`;
        }

        // ==========================================
        // INIZIALIZZAZIONE
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('📱 Dashboard Mobile - Magazzino Corretto avviata');
            
            const success = await loadAllData();
            if (success) {
                loadDashboard();
            } else {
                showError('❌ Impossibile caricare i dati. Controlla Supabase.');
            }
        });

        // Prevent zoom on iOS
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        });
    </script>
</body>
</html>
