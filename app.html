<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medei Caseificio - Dashboard Corretta</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e293b, #334155);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /* NAVIGATION */
        .nav-container {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: rgba(59, 130, 246, 0.2);
            border: 2px solid rgba(59, 130, 246, 0.3);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 600;
        }

        .nav-tab:hover {
            background: rgba(59, 130, 246, 0.4);
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-color: #3b82f6;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        /* PAGES */
        .page {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* CARDS GRID */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            border-color: #3b82f6;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.2);
        }

        .card h3 {
            color: #60a5fa;
            margin-bottom: 15px;
            font-size: 1.3em;
            text-align: center;
        }

        /* STAT CARDS */
        .stat-card {
            text-align: center;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1));
        }

        .stat-value {
            font-size: 3em;
            font-weight: bold;
            background: linear-gradient(135deg, #3b82f6, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 1.1em;
            color: #94a3b8;
            margin-top: 10px;
        }

        /* CHART CONTAINERS */
        .chart-container {
            height: 400px;
            position: relative;
        }

        .chart-container.large {
            height: 500px;
        }

        .chart-container.small {
            height: 300px;
        }

        canvas {
            background: rgba(15, 23, 42, 0.5) !important;
            border-radius: 10px;
        }

        /* FILTERS */
        .filters {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .filters h3 {
            color: #60a5fa;
            margin-bottom: 20px;
            text-align: center;
        }

        .filter-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            color: #94a3b8;
            font-size: 14px;
            font-weight: 600;
        }

        .filter-input, .filter-select {
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(59, 130, 246, 0.3);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 14px;
            min-width: 150px;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
        }

        .filter-button {
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .filter-button:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
        }

        /* MULTI-SELECT */
        .multi-select {
            position: relative;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .multi-select-dropdown.show {
            display: block;
        }

        .multi-select-option {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
        }

        .multi-select-option:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        .multi-select-option.selected {
            background: rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header h1 { font-size: 2em; }
            .nav-tabs { flex-direction: column; }
            .filter-row { flex-direction: column; align-items: stretch; }
            .cards-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>üßÄ Medei Caseificio</h1>
            <div class="subtitle">Dashboard di Analisi - Sistema POS</div>
        </div>

        <!-- NAVIGATION -->
        <div class="nav-container">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showPage('dashboard')">
                    üìä Dashboard Principale
                </button>
                <button class="nav-tab" onclick="showPage('temporal')">
                    üìÖ Analisi Temporale
                </button>
                <button class="nav-tab" onclick="showPage('trends')">
                    üìà Trend Prodotti
                </button>
                <button class="nav-tab" onclick="showPage('operators')">
                    üë®‚Äçüíº Analisi Operatori
                </button>
            </div>
        </div>

        <!-- PAGE 1: DASHBOARD PRINCIPALE -->
        <div id="dashboard" class="page active">
            <div class="cards-grid">
                <!-- STATISTICHE PRINCIPALI -->
                <div class="card stat-card">
                    <h3>üßÄ Forme Vendute Totali</h3>
                    <div class="stat-value" id="total-forms">0</div>
                    <div class="stat-label">Vendite + Fatturato</div>
                </div>

                <div class="card stat-card">
                    <h3>üí∞ Incasso Totale</h3>
                    <div class="stat-value" id="total-revenue">‚Ç¨0</div>
                    <div class="stat-label">Solo vendite con importo</div>
                </div>

                <div class="card stat-card">
                    <h3>üè™ Forme in Cella</h3>
                    <div class="stat-value" id="forms-in-cellar">0</div>
                    <div class="stat-label">Disponibili ora</div>
                </div>

                <div class="card stat-card">
                    <h3>üì¶ Operazioni Oggi</h3>
                    <div class="stat-value" id="today-operations">0</div>
                    <div class="stat-label">Tutte le operazioni</div>
                </div>
            </div>

            <div class="cards-grid">
                <!-- CLASSIFICA OPERATORI (spostata qui) -->
                <div class="card">
                    <h3>üèÜ Classifica Operatori (Totale Operazioni)</h3>
                    <div class="chart-container">
                        <canvas id="operators-ranking-chart"></canvas>
                    </div>
                </div>

                <!-- TIPOLOGIE OPERAZIONI -->
                <div class="card">
                    <h3>üìä Tipologie di Operazioni</h3>
                    <div class="chart-container">
                        <canvas id="operation-types-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="cards-grid">
                <!-- OPERAZIONI ULTIMI 7 GIORNI -->
                <div class="card">
                    <h3>üìà Operazioni Ultimi 7 Giorni</h3>
                    <div class="chart-container">
                        <canvas id="recent-operations-chart"></canvas>
                    </div>
                </div>

                <!-- TOP PRODOTTI VENDUTI -->
                <div class="card">
                    <h3>ü•á Top Prodotti Venduti</h3>
                    <div class="chart-container">
                        <canvas id="top-products-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE 2: ANALISI TEMPORALE -->
        <div id="temporal" class="page">
            <div class="filters">
                <h3>üóìÔ∏è Selezione Periodo</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Data Inizio</label>
                        <input type="date" id="start-date" class="filter-input">
                    </div>
                    <div class="filter-group">
                        <label>Data Fine</label>
                        <input type="date" id="end-date" class="filter-input">
                    </div>
                    <div class="filter-group">
                        <label>Periodo Rapido</label>
                        <select id="quick-period" class="filter-select">
                            <option value="">Seleziona periodo</option>
                            <option value="today">Oggi</option>
                            <option value="yesterday">Ieri</option>
                            <option value="last7">Ultimi 7 giorni</option>
                            <option value="last30">Ultimi 30 giorni</option>
                            <option value="thisMonth">Questo mese</option>
                            <option value="lastMonth">Mese scorso</option>
                        </select>
                    </div>
                    <button class="filter-button" onclick="applyTemporalFilter()">
                        üìä Analizza Periodo
                    </button>
                </div>
            </div>

            <div class="cards-grid">
                <div class="card">
                    <h3>üìä Operazioni per Tipologia nel Periodo</h3>
                    <div class="chart-container large">
                        <canvas id="temporal-operations-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>üìÖ Operazioni Giornaliere nel Periodo</h3>
                    <div class="chart-container large">
                        <canvas id="temporal-daily-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="cards-grid">
                <div class="card stat-card">
                    <h3>üéØ Operazioni Totali nel Periodo</h3>
                    <div class="stat-value" id="period-operations">0</div>
                    <div class="stat-label">Tutte le tipologie</div>
                </div>

                <div class="card stat-card">
                    <h3>üí∞ Incasso nel Periodo</h3>
                    <div class="stat-value" id="period-revenue">‚Ç¨0</div>
                    <div class="stat-label">Solo importi inseriti</div>
                </div>

                <div class="card stat-card">
                    <h3>üìà Media Giornaliera</h3>
                    <div class="stat-value" id="period-daily-avg">0</div>
                    <div class="stat-label">Operazioni/giorno</div>
                </div>
            </div>
        </div>

        <!-- PAGE 3: TREND PRODOTTI -->
        <div id="trends" class="page">
            <div class="filters">
                <h3>üîç Seleziona Prodotti da Analizzare</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Prodotti</label>
                        <div class="multi-select">
                            <input type="text" id="products-filter" class="filter-input" placeholder="Seleziona prodotti..." readonly onclick="toggleMultiSelect('products')">
                            <div id="products-dropdown" class="multi-select-dropdown">
                                <!-- Popolato dinamicamente -->
                            </div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>Periodo</label>
                        <select id="trend-period" class="filter-select">
                            <option value="30">Ultimi 30 giorni</option>
                            <option value="60">Ultimi 60 giorni</option>
                            <option value="90">Ultimi 90 giorni</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Tipo Grafico</label>
                        <select id="chart-type" class="filter-select">
                            <option value="line">Linea</option>
                            <option value="bar">Barre</option>
                            <option value="area">Area</option>
                        </select>
                    </div>
                    <button class="filter-button" onclick="applyTrendFilter()">
                        üìä Genera Trend
                    </button>
                </div>
            </div>

            <div class="cards-grid">
                <div class="card">
                    <h3>üìà Trend Vendite Prodotti Selezionati</h3>
                    <div class="chart-container large">
                        <canvas id="products-trend-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>üìä Vendite Cumulative</h3>
                    <div class="chart-container large">
                        <canvas id="cumulative-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE 4: ANALISI OPERATORI -->
        <div id="operators" class="page">
            <div class="filters">
                <h3>üë®‚Äçüíº Seleziona Operatore da Analizzare</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Operatore</label>
                        <select id="operator-select" class="filter-select">
                            <option value="">Tutti gli operatori</option>
                            <!-- Popolato dinamicamente -->
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Periodo</label>
                        <select id="operator-period" class="filter-select">
                            <option value="30">Ultimi 30 giorni</option>
                            <option value="60">Ultimi 60 giorni</option>
                            <option value="90">Ultimi 90 giorni</option>
                        </select>
                    </div>
                    <button class="filter-button" onclick="applyOperatorFilter()">
                        üìä Analizza Operatore
                    </button>
                </div>
            </div>

            <div class="cards-grid">
                <div class="card">
                    <h3>üìä Distribuzione Operazioni per Operatore</h3>
                    <div class="chart-container large">
                        <canvas id="operator-operations-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>üìà Operazioni nel Tempo</h3>
                    <div class="chart-container large">
                        <canvas id="operator-timeline-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="cards-grid">
                <div class="card">
                    <h3>‚è∞ Performance per Fascia Oraria</h3>
                    <div class="chart-container">
                        <canvas id="hourly-performance-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>üìÖ Attivit√† Settimanale</h3>
                    <div class="chart-container">
                        <canvas id="weekly-activity-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // VARIABILI GLOBALI
        let allData = {};
        let selectedProducts = [];
        let activeCharts = {};

        // DATI SIMULATI (da sostituire con dati reali dai CSV)
        const mockData = {
            vendite: generateMockSales(),
            fatturato: generateMockInvoices(),
            prodotti_aggiunti: generateMockProducts(),
            produzione_cella_frigo: generateMockProduction(),
            soldi: generateMockCash()
        };

        // PREZZI PRODOTTI (dal file prezzi.json)
        const prezziProdotti = {
            "Formaggio": 22.0,
            "Mezza_Forma": 11.0,
            "Forma_Stagionata": 24.0,
            "MezzaForma_Stag": 12.0,
            "Ricotta": 9.0,
            "Miele": 7.0,
            "Noci_1kg": 5.0,
            "Noci_3kg": 15.0,
            "Olio_0.25L": 5.0,
            "Olio_0.5L": 8.0,
            "Olio_0.75L": 10.0,
            "Olio_1L": 13.0,
            "Olio_2L": 24.0,
            "Olio_3L": 36.0,
            "Olio_5L": 60.0,
            "Grattugiato": 2.0
        };

        // GENERAZIONE DATI MOCK
        function generateMockSales() {
            const operators = ['Andrea', 'Doriano', 'Marco', 'Liliana', 'Mara', 'Massimo'];
            const products = ['Formaggio', 'Mezza_Forma', 'Forma_Stagionata', 'Ricotta', 'Miele', 'Olio_1L', 'Noci_1kg'];
            const data = [];
            
            for (let i = 0; i < 140; i++) {
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 60));
                
                const record = {
                    Data: date.toLocaleDateString('it-IT'),
                    Ora: `${Math.floor(Math.random() * 12) + 8}:${Math.floor(Math.random() * 60).toString().padStart(2, '0')}:00`,
                    Operatore: operators[Math.floor(Math.random() * operators.length)],
                    ImportoInserito: Math.random() > 0.3 ? (Math.random() * 200 + 20).toFixed(2) : 0
                };
                
                products.forEach(product => {
                    record[product] = Math.random() > 0.8 ? Math.floor(Math.random() * 3) + 1 : 0;
                });
                
                data.push(record);
            }
            return data;
        }

        function generateMockInvoices() {
            const operators = ['Andrea', 'Marco', 'Liliana'];
            const fatturatori = ['Bancomat', 'Conad (Trevi)', 'Regalo', 'Medei (macellaio)', 'Ulivo'];
            const products = ['Formaggio', 'Forma_Stagionata', 'Ricotta', 'Miele'];
            const data = [];
            
            for (let i = 0; i < 35; i++) {
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 45));
                
                const record = {
                    Data: date.toLocaleDateString('it-IT'),
                    Ora: `${Math.floor(Math.random() * 12) + 8}:${Math.floor(Math.random() * 60).toString().padStart(2, '0')}:00`,
                    Operatore: operators[Math.floor(Math.random() * operators.length)],
                    Fatturatore: fatturatori[Math.floor(Math.random() * fatturatori.length)]
                };
                
                products.forEach(product => {
                    record[product] = Math.random() > 0.7 ? Math.floor(Math.random() * 3) + 1 : 0;
                });
                
                data.push(record);
            }
            return data;
        }

        function generateMockProducts() {
            const operators = ['Andrea', 'Sistema'];
            const products = ['Formaggio', 'Forma_Stagionata', 'Ricotta', 'Miele'];
            const data = [];
            
            for (let i = 0; i < 15; i++) {
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 20));
                
                const record = {
                    Data: date.toLocaleDateString('it-IT'),
                    Ora: `${Math.floor(Math.random() * 12) + 8}:${Math.floor(Math.random() * 60).toString().padStart(2, '0')}:00`,
                    Operatore: operators[Math.floor(Math.random() * operators.length)]
                };
                
                products.forEach(product => {
                    record[product] = Math.random() > 0.6 ? Math.floor(Math.random() * 10) + 5 : 0;
                });
                
                data.push(record);
            }
            return data;
        }

        function generateMockProduction() {
            const data = [];
            for (let i = 0; i < 18; i++) {
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 30));
                
                data.push({
                    Data: date.toLocaleDateString('it-IT'),
                    Ora: `${Math.floor(Math.random() * 4) + 6}:${Math.floor(Math.random() * 60).toString().padStart(2, '0')}:00`,
                    Forme: Math.floor(Math.random() * 20) + 10
                });
            }
            return data;
        }

        function generateMockCash() {
            const data = [];
            for (let i = 0; i < 11; i++) {
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 15));
                
                data.push({
                    Data: date.toLocaleDateString('it-IT'),
                    Ora: `${Math.floor(Math.random() * 12) + 8}:${Math.floor(Math.random() * 60).toString().padStart(2, '0')}:00`,
                    Importo: (Math.random() * 500 + 100).toFixed(2)
                });
            }
            return data;
        }

        // NAVIGATION
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
            
            loadPageData(pageId);
        }

        function loadPageData(pageId) {
            switch(pageId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'temporal':
                    loadTemporal();
                    break;
                case 'trends':
                    loadTrends();
                    break;
                case 'operators':
                    loadOperators();
                    break;
            }
        }

        // DASHBOARD PRINCIPALE
        function loadDashboard() {
            const totalForms = calculateTotalForms();
            const totalRevenue = calculateTotalRevenue();
            const formsInCellar = calculateFormsInCellar();
            const todayOperations = calculateTodayOperations();
            
            document.getElementById('total-forms').textContent = totalForms;
            document.getElementById('total-revenue').textContent = `‚Ç¨${totalRevenue.toLocaleString()}`;
            document.getElementById('forms-in-cellar').textContent = formsInCellar;
            document.getElementById('today-operations').textContent = todayOperations;
            
            createOperatorsRankingChart();
            createOperationTypesChart();
            createRecentOperationsChart();
            createTopProductsChart();
        }

        function calculateTotalForms() {
            let total = 0;
            [...mockData.vendite, ...mockData.fatturato].forEach(record => {
                total += (parseFloat(record.Formaggio) || 0) + (parseFloat(record.Forma_Stagionata) || 0);
            });
            return total;
        }

        function calculateTotalRevenue() {
            let total = 0;
            mockData.vendite.forEach(record => {
                if (record.ImportoInserito && parseFloat(record.ImportoInserito) > 0) {
                    total += parseFloat(record.ImportoInserito);
                }
            });
            return Math.round(total);
        }

        function calculateFormsInCellar() {
            let produced = 0;
            let sold = 0;
            
            mockData.produzione_cella_frigo.forEach(record => {
                produced += parseFloat(record.Forme) || 0;
            });
            
            [...mockData.vendite, ...mockData.fatturato].forEach(record => {
                sold += (parseFloat(record.Formaggio) || 0) + (parseFloat(record.Forma_Stagionata) || 0);
            });
            
            return Math.max(0, produced - sold);
        }

        function calculateTodayOperations() {
            const today = new Date().toLocaleDateString('it-IT');
            let operations = 0;
            
            [...mockData.vendite, ...mockData.fatturato, ...mockData.prodotti_aggiunti].forEach(record => {
                if (record.Data === today) {
                    operations++;
                }
            });
            
            return operations;
        }

        function createOperatorsRankingChart() {
            const ctx = document.getElementById('operators-ranking-chart');
            if (!ctx) return;
            
            if (activeCharts['operators-ranking']) {
                activeCharts['operators-ranking'].destroy();
            }
            
            const operatorsOperations = {};
            
            [...mockData.vendite, ...mockData.fatturato, ...mockData.prodotti_aggiunti].forEach(record => {
                const operator = record.Operatore;
                if (!operatorsOperations[operator]) operatorsOperations[operator] = 0;
                operatorsOperations[operator]++;
            });
            
            const sortedOperators = Object.entries(operatorsOperations)
                .sort((a, b) => b[1] - a[1]);
            
            activeCharts['operators-ranking'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedOperators.map(([name]) => name),
                    datasets: [{
                        label: 'Operazioni Totali',
                        data: sortedOperators.map(([, operations]) => operations),
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'],
                        borderWidth: 2,
                        borderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        function createOperationTypesChart() {
            const ctx = document.getElementById('operation-types-chart');
            if (!ctx) return;
            
            if (activeCharts['operation-types']) {
                activeCharts['operation-types'].destroy();
            }
            
            // Calcola le 5 tipologie richieste
            const operationTypes = {
                'Vendite': mockData.vendite.length,
                'Aggiunti': mockData.prodotti_aggiunti.length,
                'Fatturato': 0,
                'Bancomat': 0,
                'Regalo': 0
            };
            
            mockData.fatturato.forEach(record => {
                if (record.Fatturatore === 'Bancomat') {
                    operationTypes['Bancomat']++;
                } else if (record.Fatturatore === 'Regalo') {
                    operationTypes['Regalo']++;
                } else {
                    operationTypes['Fatturato']++;
                }
            });
            
            activeCharts['operation-types'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(operationTypes),
                    datasets: [{
                        data: Object.values(operationTypes),
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'],
                        borderWidth: 2,
                        borderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        function createRecentOperationsChart() {
            const ctx = document.getElementById('recent-operations-chart');
            if (!ctx) return;
            
            if (activeCharts['recent-operations']) {
                activeCharts['recent-operations'].destroy();
            }
            
            // Ultimi 7 giorni con separazione per tipologia
            const last7Days = [];
            const operationsByDay = {
                'Vendite': [],
                'Fatturato': [],
                'Bancomat': [],
                'Regalo': [],
                'Aggiunti': []
            };
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString('it-IT');
                last7Days.push(dateStr);
                
                let vendite = 0, fatturato = 0, bancomat = 0, regalo = 0, aggiunti = 0;
                
                mockData.vendite.forEach(record => {
                    if (record.Data === dateStr) vendite++;
                });
                
                mockData.fatturato.forEach(record => {
                    if (record.Data === dateStr) {
                        if (record.Fatturatore === 'Bancomat') bancomat++;
                        else if (record.Fatturatore === 'Regalo') regalo++;
                        else fatturato++;
                    }
                });
                
                mockData.prodotti_aggiunti.forEach(record => {
                    if (record.Data === dateStr) aggiunti++;
                });
                
                operationsByDay['Vendite'].push(vendite);
                operationsByDay['Fatturato'].push(fatturato);
                operationsByDay['Bancomat'].push(bancomat);
                operationsByDay['Regalo'].push(regalo);
                operationsByDay['Aggiunti'].push(aggiunti);
            }
            
            activeCharts['recent-operations'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: last7Days,
                    datasets: [
                        {
                            label: 'Vendite',
                            data: operationsByDay['Vendite'],
                            backgroundColor: '#10b981',
                            stack: 'stack1'
                        },
                        {
                            label: 'Fatturato',
                            data: operationsByDay['Fatturato'],
                            backgroundColor: '#3b82f6',
                            stack: 'stack1'
                        },
                        {
                            label: 'Bancomat',
                            data: operationsByDay['Bancomat'],
                            backgroundColor: '#f59e0b',
                            stack: 'stack1'
                        },
                        {
                            label: 'Regalo',
                            data: operationsByDay['Regalo'],
                            backgroundColor: '#ef4444',
                            stack: 'stack1'
                        },
                        {
                            label: 'Aggiunti',
                            data: operationsByDay['Aggiunti'],
                            backgroundColor: '#8b5cf6',
                            stack: 'stack1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8' }
                        }
                    },
                    scales: {
                        y: {
                            stacked: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            stacked: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        function createTopProductsChart() {
            const ctx = document.getElementById('top-products-chart');
            if (!ctx) return;
            
            if (activeCharts['top-products']) {
                activeCharts['top-products'].destroy();
            }
            
            const productSales = {};
            const products = ['Formaggio', 'Forma_Stagionata', 'Ricotta', 'Miele', 'Olio_1L', 'Noci_1kg'];
            
            products.forEach(product => productSales[product] = 0);
            
            [...mockData.vendite, ...mockData.fatturato].forEach(record => {
                products.forEach(product => {
                    productSales[product] += parseFloat(record[product]) || 0;
                });
            });
            
            const sortedProducts = Object.entries(productSales)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            activeCharts['top-products'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedProducts.map(([name]) => name.replace(/_/g, ' ')),
                    datasets: [{
                        label: 'Quantit√† Venduta',
                        data: sortedProducts.map(([, value]) => value),
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'],
                        borderWidth: 2,
                        borderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        // ANALISI TEMPORALE
        function loadTemporal() {
            setupDateFilters();
        }

        function setupDateFilters() {
            const today = new Date();
            const startDate = document.getElementById('start-date');
            const endDate = document.getElementById('end-date');
            
            const lastMonth = new Date();
            lastMonth.setDate(lastMonth.getDate() - 30);
            
            startDate.value = lastMonth.toISOString().split('T')[0];
            endDate.value = today.toISOString().split('T')[0];
            
            document.getElementById('quick-period').addEventListener('change', function() {
                const period = this.value;
                const today = new Date();
                let start = new Date();
                
                switch(period) {
                    case 'today':
                        start = new Date();
                        break;
                    case 'yesterday':
                        start = new Date();
                        start.setDate(start.getDate() - 1);
                        today.setDate(today.getDate() - 1);
                        break;
                    case 'last7':
                        start.setDate(start.getDate() - 7);
                        break;
                    case 'last30':
                        start.setDate(start.getDate() - 30);
                        break;
                    case 'thisMonth':
                        start = new Date(today.getFullYear(), today.getMonth(), 1);
                        break;
                    case 'lastMonth':
                        start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        const end = new Date(today.getFullYear(), today.getMonth(), 0);
                        endDate.value = end.toISOString().split('T')[0];
                        break;
                }
                
                startDate.value = start.toISOString().split('T')[0];
                if (period !== 'lastMonth') {
                    endDate.value = today.toISOString().split('T')[0];
                }
            });
        }

        function applyTemporalFilter() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) {
                alert('Seleziona entrambe le date');
                return;
            }
            
            const filteredData = filterDataByPeriod(startDate, endDate);
            updatePeriodStats(filteredData);
            createTemporalOperationsChart(filteredData);
            createTemporalDailyChart(filteredData);
        }

        function filterDataByPeriod(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            const filtered = {
                vendite: [],
                fatturato: [],
                prodotti_aggiunti: []
            };
            
            [
                ...mockData.vendite.map(r => ({...r, type: 'vendite'})),
                ...mockData.fatturato.map(r => ({...r, type: 'fatturato'})),
                ...mockData.prodotti_aggiunti.map(r => ({...r, type: 'prodotti_aggiunti'}))
            ].forEach(record => {
                const recordDate = new Date(record.Data.split('/').reverse().join('-'));
                if (recordDate >= start && recordDate <= end) {
                    filtered[record.type].push(record);
                }
            });
            
            return filtered;
        }

        function updatePeriodStats(filteredData) {
            const totalOperations = filteredData.vendite.length + filteredData.fatturato.length + filteredData.prodotti_aggiunti.length;
            
            let revenue = 0;
            filteredData.vendite.forEach(record => {
                revenue += parseFloat(record.ImportoInserito) || 0;
            });
            
            const startDate = new Date(document.getElementById('start-date').value);
            const endDate = new Date(document.getElementById('end-date').value);
            const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            const dailyAvg = Math.round(totalOperations / daysDiff * 100) / 100;
            
            document.getElementById('period-operations').textContent = totalOperations;
            document.getElementById('period-revenue').textContent = `‚Ç¨${Math.round(revenue).toLocaleString()}`;
            document.getElementById('period-daily-avg').textContent = dailyAvg;
        }

        function createTemporalOperationsChart(filteredData) {
            const ctx = document.getElementById('temporal-operations-chart');
            if (!ctx) return;
            
            if (activeCharts['temporal-operations']) {
                activeCharts['temporal-operations'].destroy();
            }
            
            // Conta per tipologia
            const operationTypes = {
                'Vendite': filteredData.vendite.length,
                'Aggiunti': filteredData.prodotti_aggiunti.length,
                'Fatturato': 0,
                'Bancomat': 0,
                'Regalo': 0
            };
            
            filteredData.fatturato.forEach(record => {
                if (record.Fatturatore === 'Bancomat') {
                    operationTypes['Bancomat']++;
                } else if (record.Fatturatore === 'Regalo') {
                    operationTypes['Regalo']++;
                } else {
                    operationTypes['Fatturato']++;
                }
            });
            
            activeCharts['temporal-operations'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(operationTypes),
                    datasets: [{
                        label: 'Operazioni nel Periodo',
                        data: Object.values(operationTypes),
                        backgroundColor: ['#10b981', '#8b5cf6', '#3b82f6', '#f59e0b', '#ef4444'],
                        borderWidth: 2,
                        borderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        function createTemporalDailyChart(filteredData) {
            const ctx = document.getElementById('temporal-daily-chart');
            if (!ctx) return;
            
            if (activeCharts['temporal-daily']) {
                activeCharts['temporal-daily'].destroy();
            }
            
            const operationsByDay = {};
            
            [...filteredData.vendite, ...filteredData.fatturato, ...filteredData.prodotti_aggiunti].forEach(record => {
                const date = record.Data;
                if (!operationsByDay[date]) operationsByDay[date] = 0;
                operationsByDay[date]++;
            });
            
            const sortedDates = Object.keys(operationsByDay).sort((a, b) => {
                return new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-'));
            });
            
            activeCharts['temporal-daily'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Operazioni Giornaliere',
                        data: sortedDates.map(date => operationsByDay[date]),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { 
                                color: '#94a3b8',
                                maxRotation: 45
                            },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        // TREND PRODOTTI
        function loadTrends() {
            setupProductsFilter();
        }

        function setupProductsFilter() {
            const products = ['Formaggio', 'Forma_Stagionata', 'Ricotta', 'Miele', 'Olio_1L', 'Noci_1kg', 'Noci_3kg', 'Grattugiato'];
            populateMultiSelect('products', products);
        }

        function populateMultiSelect(type, options) {
            const dropdown = document.getElementById(`${type}-dropdown`);
            dropdown.innerHTML = '';
            
            options.forEach(option => {
                const div = document.createElement('div');
                div.className = 'multi-select-option';
                div.textContent = option.replace(/_/g, ' ');
                div.onclick = () => toggleOption(type, option, div);
                dropdown.appendChild(div);
            });
        }

        function toggleMultiSelect(type) {
            const dropdown = document.getElementById(`${type}-dropdown`);
            dropdown.classList.toggle('show');
            
            document.querySelectorAll('.multi-select-dropdown').forEach(d => {
                if (d !== dropdown) d.classList.remove('show');
            });
        }

        function toggleOption(type, option, element) {
            const index = selectedProducts.indexOf(option);
            
            if (index > -1) {
                selectedProducts.splice(index, 1);
                element.classList.remove('selected');
            } else {
                selectedProducts.push(option);
                element.classList.add('selected');
            }
            
            updateFilterDisplay();
        }

        function updateFilterDisplay() {
            const input = document.getElementById('products-filter');
            
            if (selectedProducts.length === 0) {
                input.value = 'Seleziona prodotti...';
            } else {
                input.value = `${selectedProducts.length} selezionati`;
            }
        }

        function applyTrendFilter() {
            if (selectedProducts.length === 0) {
                alert('Seleziona almeno un prodotto');
                return;
            }
            
            createProductsTrendChart();
            createCumulativeChart();
        }

        function createProductsTrendChart() {
            const ctx = document.getElementById('products-trend-chart');
            if (!ctx) return;
            
            if (activeCharts['products-trend']) {
                activeCharts['products-trend'].destroy();
            }
            
            const chartType = document.getElementById('chart-type').value;
            const period = parseInt(document.getElementById('trend-period').value);
            
            const days = [];
            const datasets = [];
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
            
            // Genera giorni
            for (let i = period - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(date.toLocaleDateString('it-IT'));
            }
            
            // Per ogni prodotto selezionato
            selectedProducts.forEach((product, index) => {
                const productData = [];
                
                days.forEach(day => {
                    let dayTotal = 0;
                    [...mockData.vendite, ...mockData.fatturato].forEach(record => {
                        if (record.Data === day) {
                            dayTotal += parseFloat(record[product]) || 0;
                        }
                    });
                    productData.push(dayTotal);
                });
                
                datasets.push({
                    label: product.replace(/_/g, ' '),
                    data: productData,
                    borderColor: colors[index % colors.length],
                    backgroundColor: chartType === 'area' ? colors[index % colors.length] + '20' : colors[index % colors.length],
                    tension: 0.4,
                    fill: chartType === 'area'
                });
            });
            
            activeCharts['products-trend'] = new Chart(ctx, {
                type: chartType === 'area' ? 'line' : chartType,
                data: {
                    labels: days,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { 
                                color: '#94a3b8',
                                maxTicksLimit: 15
                            },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        function createCumulativeChart() {
            const ctx = document.getElementById('cumulative-chart');
            if (!ctx) return;
            
            if (activeCharts['cumulative']) {
                activeCharts['cumulative'].destroy();
            }
            
            const period = parseInt(document.getElementById('trend-period').value);
            const days = [];
            const datasets = [];
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
            
            for (let i = period - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(date.toLocaleDateString('it-IT'));
            }
            
            selectedProducts.forEach((product, index) => {
                const cumulativeData = [];
                let cumulative = 0;
                
                days.forEach(day => {
                    let dayTotal = 0;
                    [...mockData.vendite, ...mockData.fatturato].forEach(record => {
                        if (record.Data === day) {
                            dayTotal += parseFloat(record[product]) || 0;
                        }
                    });
                    cumulative += dayTotal;
                    cumulativeData.push(cumulative);
                });
                
                datasets.push({
                    label: product.replace(/_/g, ' ') + ' (Cumulativo)',
                    data: cumulativeData,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    tension: 0.4,
                    fill: false
                });
            });
            
            activeCharts['cumulative'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { 
                                color: '#94a3b8',
                                maxTicksLimit: 15
                            },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        // ANALISI OPERATORI
        function loadOperators() {
            setupOperatorsFilter();
        }

        function setupOperatorsFilter() {
            const operators = ['Andrea', 'Doriano', 'Marco', 'Liliana', 'Mara', 'Massimo'];
            const select = document.getElementById('operator-select');
            
            operators.forEach(operator => {
                const option = document.createElement('option');
                option.value = operator;
                option.textContent = operator;
                select.appendChild(option);
            });
        }

        function applyOperatorFilter() {
            const selectedOperator = document.getElementById('operator-select').value;
            const period = parseInt(document.getElementById('operator-period').value);
            
            createOperatorOperationsChart(selectedOperator);
            createOperatorTimelineChart(selectedOperator, period);
            createHourlyPerformanceChart(selectedOperator);
            createWeeklyActivityChart(selectedOperator);
        }

        function createOperatorOperationsChart(selectedOperator) {
            const ctx = document.getElementById('operator-operations-chart');
            if (!ctx) return;
            
            if (activeCharts['operator-operations']) {
                activeCharts['operator-operations'].destroy();
            }
            
            let dataToAnalyze = [];
            if (selectedOperator) {
                // Filtra per operatore specifico
                dataToAnalyze = [
                    ...mockData.vendite.filter(r => r.Operatore === selectedOperator),
                    ...mockData.fatturato.filter(r => r.Operatore === selectedOperator),
                    ...mockData.prodotti_aggiunti.filter(r => r.Operatore === selectedOperator)
                ];
            } else {
                // Tutti gli operatori
                dataToAnalyze = [...mockData.vendite, ...mockData.fatturato, ...mockData.prodotti_aggiunti];
            }
            
            const operationTypes = {
                'Vendite': 0,
                'Aggiunti': 0,
                'Fatturato': 0,
                'Bancomat': 0,
                'Regalo': 0
            };
            
            dataToAnalyze.forEach(record => {
                if (mockData.vendite.includes(record)) {
                    operationTypes['Vendite']++;
                } else if (mockData.prodotti_aggiunti.includes(record)) {
                    operationTypes['Aggiunti']++;
                } else if (mockData.fatturato.includes(record)) {
                    if (record.Fatturatore === 'Bancomat') {
                        operationTypes['Bancomat']++;
                    } else if (record.Fatturatore === 'Regalo') {
                        operationTypes['Regalo']++;
                    } else {
                        operationTypes['Fatturato']++;
                    }
                }
            });
            
            activeCharts['operator-operations'] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(operationTypes),
                    datasets: [{
                        data: Object.values(operationTypes),
                        backgroundColor: ['#10b981', '#8b5cf6', '#3b82f6', '#f59e0b', '#ef4444'],
                        borderWidth: 2,
                        borderColor: '#1e293b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8' }
                        },
                        title: {
                            display: true,
                            text: selectedOperator ? `Operazioni di ${selectedOperator}` : 'Operazioni di Tutti gli Operatori',
                            color: '#94a3b8'
                        }
                    }
                }
            });
        }

        function createOperatorTimelineChart(selectedOperator, period) {
            const ctx = document.getElementById('operator-timeline-chart');
            if (!ctx) return;
            
            if (activeCharts['operator-timeline']) {
                activeCharts['operator-timeline'].destroy();
            }
            
            const days = [];
            const operationsData = [];
            
            for (let i = period - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString('it-IT');
                days.push(dateStr);
                
                let dayOperations = 0;
                [...mockData.vendite, ...mockData.fatturato, ...mockData.prodotti_aggiunti].forEach(record => {
                    if (record.Data === dateStr) {
                        if (!selectedOperator || record.Operatore === selectedOperator) {
                            dayOperations++;
                        }
                    }
                });
                
                operationsData.push(dayOperations);
            }
            
            activeCharts['operator-timeline'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [{
                        label: selectedOperator ? `Operazioni di ${selectedOperator}` : 'Operazioni Totali',
                        data: operationsData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { 
                                color: '#94a3b8',
                                maxTicksLimit: 15
                            },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        function createHourlyPerformanceChart(selectedOperator) {
            const ctx = document.getElementById('hourly-performance-chart');
            if (!ctx) return;
            
            if (activeCharts['hourly-performance']) {
                activeCharts['hourly-performance'].destroy();
            }
            
            const hours = Array.from({length: 12}, (_, i) => `${i + 8}:00`);
            const hourlyData = {};
            
            hours.forEach(hour => hourlyData[hour] = 0);
            
            [...mockData.vendite, ...mockData.fatturato, ...mockData.prodotti_aggiunti].forEach(record => {
                if (!selectedOperator || record.Operatore === selectedOperator) {
                    const hour = record.Ora.split(':')[0] + ':00';
                    if (hourlyData[hour] !== undefined) {
                        hourlyData[hour]++;
                    }
                }
            });
            
            activeCharts['hourly-performance'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Operazioni per Ora',
                        data: hours.map(hour => hourlyData[hour]),
                        backgroundColor: '#3b82f6',
                        borderColor: '#1d4ed8',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        function createWeeklyActivityChart(selectedOperator) {
            const ctx = document.getElementById('weekly-activity-chart');
            if (!ctx) return;
            
            if (activeCharts['weekly-activity']) {
                activeCharts['weekly-activity'].destroy();
            }
            
            const weekDays = ['Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato', 'Domenica'];
            const weekData = weekDays.map(() => 0);
            
            // Simulazione dati settimanali
            [...mockData.vendite, ...mockData.fatturato, ...mockData.prodotti_aggiunti].forEach(record => {
                if (!selectedOperator || record.Operatore === selectedOperator) {
                    const randomDay = Math.floor(Math.random() * 7);
                    weekData[randomDay]++;
                }
            });
            
            activeCharts['weekly-activity'] = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: weekDays,
                    datasets: [{
                        label: 'Attivit√† Settimanale',
                        data: weekData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8' }
                        }
                    },
                    scales: {
                        r: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        // UTILITY FUNCTIONS
        function destroyChart(chartId) {
            if (activeCharts[chartId]) {
                activeCharts[chartId].destroy();
                delete activeCharts[chartId];
            }
        }

        // Chiudi dropdown quando clicchi fuori
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.multi-select')) {
                document.querySelectorAll('.multi-select-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
        });

        // INIZIALIZZAZIONE
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Dashboard caricata - Versione Corretta');
            loadDashboard();
            
            // Applica filtri iniziali per operatori
            applyOperatorFilter();
        });
    </script>
</body>
</html>